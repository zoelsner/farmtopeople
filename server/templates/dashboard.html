<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Your Meal Plan - Farm to People</title>
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #f8f9fa;
            padding-bottom: 80px; /* Space for bottom tabs */
        }

        /* Top Header */
        .header {
            background: white;
            padding: 20px;
            border-bottom: 1px solid #e9ecef;
            position: sticky;
            top: 0;
            z-index: 100;
        }

        .header h1 {
            font-size: 24px;
            color: #212529;
            margin-bottom: 4px;
        }

        .header .subtitle {
            color: #6c757d;
            font-size: 14px;
        }

        /* Main Content Area */
        .content {
            padding: 20px;
            max-width: 600px;
            margin: 0 auto;
            min-height: calc(100vh - 200px);
        }

        /* Start Screen - Before Analysis */
        .start-screen {
            text-align: center;
            padding: 40px 20px;
        }

        .start-icon {
            font-size: 48px;
            margin-bottom: 20px;
        }

        .start-title {
            font-size: 24px;
            font-weight: 600;
            color: #212529;
            margin-bottom: 8px;
        }

        .start-description {
            font-size: 16px;
            color: #6c757d;
            margin-bottom: 24px;
            line-height: 1.4;
        }

        .analyze-button {
            background: #28a745;
            color: white;
            border: none;
            padding: 18px 40px;
            font-size: 18px;
            font-weight: 600;
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.2s ease;
            display: inline-block;
        }

        .analyze-button:hover {
            background: #218838;
            transform: translateY(-2px);
        }

        .analyze-button:active {
            transform: translateY(0);
        }

        /* Loading State */
        .loading-screen {
            text-align: center;
            padding: 60px 20px;
            display: none;
        }

        .loading-animation {
            width: 80px;
            height: 80px;
            margin: 0 auto 24px;
            border: 4px solid #e9ecef;
            border-top: 4px solid #28a745;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .loading-title {
            font-size: 24px;
            font-weight: 600;
            color: #212529;
            margin-bottom: 12px;
        }

        .loading-status {
            font-size: 16px;
            color: #6c757d;
            margin-bottom: 8px;
        }

        .loading-tip {
            background: #e3f2fd;
            border-radius: 12px;
            padding: 20px;
            margin-top: 32px;
            max-width: 400px;
            margin-left: auto;
            margin-right: auto;
        }

        .loading-tip h3 {
            font-size: 16px;
            color: #1976d2;
            margin-bottom: 12px;
        }

        .loading-tip p {
            font-size: 14px;
            color: #495057;
            line-height: 1.4;
            margin-bottom: 16px;
        }

        .home-screen-prompt {
            background: white;
            border: 2px solid #1976d2;
            border-radius: 8px;
            padding: 12px;
            font-size: 14px;
            color: #1976d2;
            font-weight: 500;
            cursor: pointer;
            text-decoration: none;
            display: inline-block;
        }

        /* Cart Analysis Display */
        .cart-analysis {
            display: none;
        }

        .cart-section {
            background: white;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
        }

        .section-header {
            font-size: 18px;
            font-weight: 600;
            color: #212529;
            margin-bottom: 16px;
            padding-bottom: 8px;
            border-bottom: 2px solid #e9ecef;
        }

        .item-grid {
            display: grid;
            gap: 12px;
        }

        .cart-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px;
            background: #f8f9fa;
            border-radius: 8px;
        }

        .item-details {
            flex: 1;
        }

        .item-name {
            font-size: 14px;
            font-weight: 600;
            color: #4169E1; /* Penny blue for item names */
            margin-bottom: 4px;
        }

        .item-meta {
            font-size: 12px;
            color: #6c757d;
        }

        .item-price {
            font-size: 14px;
            font-weight: 600;
            color: #28a745;
        }

        .box-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
        }

        .box-name {
            font-size: 16px;
            font-weight: 600;
            color: #212529;
        }

        .box-status {
            font-size: 12px;
            color: #6c757d;
            background: #e9ecef;
            padding: 4px 8px;
            border-radius: 4px;
        }

        .swap-suggestion {
            background: #fff3cd;
            border-left: 4px solid #ffc107;
            padding: 12px;
            margin-bottom: 12px;
            border-radius: 4px;
        }

        .swap-text {
            font-size: 14px;
            color: #856404;
        }

        .addon-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px;
            background: #d4edda;
            border-radius: 8px;
            margin-bottom: 8px;
        }

        /* Bottom Tab Navigation */
        .bottom-tabs {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: #4169E1; /* Penny blue background */
            border-top: 1px solid #3557d1;
            display: flex;
            justify-content: space-around;
            padding: 8px 0;
            padding-bottom: calc(8px + env(safe-area-inset-bottom)); /* iPhone safe area */
            z-index: 1000;
        }

        .tab {
            flex: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 8px;
            text-decoration: none;
            color: rgba(255, 255, 255, 0.7); /* White text, semi-transparent */
            transition: all 0.2s ease;
        }

        .tab.active {
            color: white; /* Pure white when active */
        }

        .tab-icon {
            width: 20px;
            height: 20px;
            margin-bottom: 4px;
            fill: currentColor;
        }

        .tab-label {
            font-size: 11px;
            font-weight: 500;
        }

        /* 2D SVG Icons */
        .icon-home {
            fill: currentColor;
        }

        .icon-cart {
            fill: currentColor;
        }

        .icon-settings {
            fill: currentColor;
        }

        /* Tighter layout */
        .content {
            padding: 16px;
            max-width: 600px;
            margin: 0 auto;
            min-height: calc(100vh - 180px);
        }

        .cart-section {
            background: white;
            border-radius: 8px;
            padding: 16px;
            margin-bottom: 16px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.05);
        }

        .section-header {
            font-size: 16px;
            font-weight: 600;
            color: #212529;
            margin-bottom: 12px;
            padding-bottom: 6px;
            border-bottom: 1px solid #e9ecef;
        }

        .item-grid {
            display: grid;
            gap: 8px;
        }

        .cart-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px;
            background: #f8f9fa;
            border-radius: 6px;
        }

        /* Hide sections by default */
        .section {
            display: none;
        }

        .section.active {
            display: block;
        }

        /* Responsive adjustments */
        @media (max-width: 380px) {
            .start-title {
                font-size: 24px;
            }
            
            .start-description {
                font-size: 16px;
            }
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>Cart Analysis</h1>
        <p class="subtitle" id="headerSubtitle">Ready to analyze your cart</p>
    </div>

    <div class="content">
        <!-- Start Screen - Shows First -->
        <div class="start-screen section active" id="startSection">
            <div class="start-icon">üì¶</div>
            <h2 class="start-title">Cart Analysis</h2>
            <p class="start-description">
                See what's in your Farm to People cart, suggested swaps, and add-ons.
            </p>
            <button class="analyze-button" onclick="startAnalysis()">
                Analyze My Cart
            </button>
        </div>

        <!-- Loading Screen - Shows During Analysis -->
        <div class="loading-screen section" id="loadingSection">
            <div class="loading-animation"></div>
            <h2 class="loading-title">Analyzing Your Cart</h2>
            <p class="loading-status" id="loadingStatus">Logging into Farm to People...</p>
            
            <div class="loading-tip">
                <h3>While you wait (20-30 seconds)</h3>
                <p>Add this page to your home screen for easy access:</p>
                <button class="home-screen-prompt" onclick="showAddToHomeScreen()">
                    Add to Home Screen
                </button>
            </div>
        </div>

        <!-- Cart Analysis Display - Shows After Analysis -->
        <div class="cart-analysis section" id="cartAnalysisSection">
            <!-- Suggested Meals - TOP PRIORITY -->
            <div class="cart-section" id="suggestedMealsSection">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px;">
                    <h3 class="section-header" style="margin: 0;">Suggested Meals</h3>
                    <button id="refreshCartButton" onclick="refreshCartData()" 
                            style="background: #007AFF; color: white; border: none; border-radius: 8px; padding: 8px 16px; font-size: 14px; font-weight: 600; cursor: pointer;">
                        üîÑ Refresh Cart
                    </button>
                </div>
                <div id="suggestedMeals">
                    <!-- Suggested meals based on preferences will be inserted here -->
                </div>
            </div>

            <!-- Individual Items -->
            <div class="cart-section" id="individualItemsSection">
                <h3 class="section-header">
                    Individual Items <span id="individualItemsCount" style="color: #666; font-weight: normal; font-size: 16px;"></span>
                </h3>
                <div class="item-grid" id="individualItems">
                    <!-- Individual items will be inserted here -->
                </div>
            </div>

            <!-- Customizable Boxes -->
            <div class="cart-section" id="customizableBoxesSection">
                <h3 class="section-header">
                    Customizable Boxes <span id="customizableBoxesCount" style="color: #666; font-weight: normal; font-size: 16px;"></span>
                </h3>
                <div id="customizableBoxes">
                    <!-- Customizable box data will be inserted here -->
                </div>
            </div>

            <!-- Non-Customizable Boxes -->
            <div class="cart-section" id="nonCustomizableBoxesSection">
                <h3 class="section-header">
                    Fixed Boxes <span id="fixedBoxesCount" style="color: #666; font-weight: normal; font-size: 16px;"></span>
                </h3>
                <div id="nonCustomizableBoxes">
                    <!-- Non-customizable box data will be inserted here -->
                </div>
            </div>

            <!-- Suggested Swaps -->
            <div class="cart-section" id="swapsSection">
                <h3 class="section-header">Suggested Swaps</h3>
                <div id="suggestedSwaps">
                    <!-- Swap suggestions will be inserted here -->
                </div>
            </div>

            <!-- Recommended Add-ons -->
            <div class="cart-section" id="addonsSection">
                <h3 class="section-header" style="display: flex; align-items: center;">
                    <span style="font-size: 20px; margin-right: 8px;">+</span> Premium Add-Ons
                </h3>
                <div id="recommendedAddons">
                    <!-- Add-on recommendations will be inserted here -->
                </div>
            </div>
        </div>

        <!-- Meals View - Shows suggested meals based on cart -->
        <div class="meals-view section" id="mealsSection">
            <h2>üçΩÔ∏è Suggested Meals</h2>
            <p style="color: #6c757d; margin-top: 20px;">Based on your cart contents</p>
            
            <!-- Refresh button for new suggestions -->
            <div style="text-align: center; margin: 20px 0;">
                <button id="refreshMeals" class="analyze-button" style="background: #6c757d; padding: 12px 24px;">
                    üîÑ Try Different Meals (<span id="refreshCount">3</span> left)
                </button>
            </div>
            
            <!-- Meal suggestions will be dynamically added here -->
            <div id="mealSuggestionsContainer"></div>
        </div>

        <!-- Settings - Hidden for now -->
        <div class="settings-view section" id="settingsSection">
            <h2>Settings</h2>
            <p style="color: #6c757d; margin-top: 20px;">Preferences and account settings</p>
        </div>
    </div>

    <!-- Bottom Tab Navigation -->
    <nav class="bottom-tabs">
        <a href="#cart" class="tab active" onclick="switchTab('cart', this)">
            <svg class="tab-icon icon-cart" viewBox="0 0 24 24">
                <circle cx="8" cy="21" r="1"/>
                <circle cx="19" cy="21" r="1"/>
                <path d="m2.05 2.05h2l2.66 12.42a2 2 0 0 0 2 1.58h9.78a2 2 0 0 0 1.95-1.57l1.65-7.43H5.12"/>
            </svg>
            <span class="tab-label">Cart</span>
        </a>
        <a href="#meals" class="tab" onclick="switchTab('meals', this)">
            <svg class="tab-icon icon-meals" viewBox="0 0 24 24">
                <path d="M8.1 13.34l2.83-2.83L3.91 3.5c-1.56 1.56-1.56 4.09 0 5.66l4.19 4.18zm6.78-1.81c1.53.71 3.68.21 5.27-1.38 1.91-1.91 2.28-4.65.81-6.12-1.46-1.46-4.2-1.1-6.12.81-1.59 1.59-2.09 3.74-1.38 5.27L3.7 19.87l1.41 1.41L12 14.41l6.88 6.88 1.41-1.41L13.41 11.73z"/>
            </svg>
            <span class="tab-label">Meals</span>
        </a>
        <a href="/settings" class="tab">
            <svg class="tab-icon icon-settings" viewBox="0 0 24 24">
                <path d="M12 8c-2.21 0-4 1.79-4 4s1.79 4 4 4 4-1.79 4-4-1.79-4-4-4zm8.94 3c-.46-4.17-3.77-7.48-7.94-7.94V1h-2v2.06C6.83 3.52 3.52 6.83 3.06 11H1v2h2.06c.46 4.17 3.77 7.48 7.94 7.94V23h2v-2.06c4.17-.46 7.48-3.77 7.94-7.94H23v-2h-2.06zM12 19c-3.87 0-7-3.13-7-7s3.13-7 7-7 7 3.13 7 7-3.13 7-7 7z"/>
            </svg>
            <span class="tab-label">Settings</span>
        </a>
    </nav>

    <script>
        let currentState = 'start'; // start, loading, complete
        let mealPlanData = null;
        let refreshesLeft = 3;  // Track refresh count

        // Check if we have saved credentials
        const userEmail = localStorage.getItem('ftpEmail');
        if (userEmail) {
            document.querySelector('.subtitle').textContent = userEmail;
        }
        
        // Restore cart analysis state if available (fixes navigation issue)
        const savedState = localStorage.getItem('cartAnalysisState');
        const savedAnalysis = localStorage.getItem('cartAnalysisData');
        if (savedState === 'complete' && savedAnalysis) {
            try {
                const { cartData, swaps, addons, timestamp } = JSON.parse(savedAnalysis);
                // Only restore if data is less than 1 hour old
                const oneHour = 60 * 60 * 1000;
                if (Date.now() - timestamp < oneHour) {
                    currentState = 'complete';
                    // Restore the cart view after a short delay to ensure DOM is ready
                    setTimeout(() => {
                        showCartAnalysis(cartData, swaps, addons);
                    }, 100);
                } else {
                    // Clear old data
                    localStorage.removeItem('cartAnalysisData');
                    localStorage.removeItem('cartAnalysisState');
                }
            } catch (e) {
                console.error('Error restoring cart analysis:', e);
            }
        }

        async function startAnalysis() {
            // Clear any previous analysis data
            localStorage.removeItem('cartAnalysisData');
            localStorage.removeItem('cartAnalysisState');
            
            // Switch to loading state
            currentState = 'loading';
            document.getElementById('startSection').classList.remove('active');
            document.getElementById('loadingSection').classList.add('active');
            document.getElementById('headerSubtitle').textContent = 'Analyzing...';

            // Update loading status messages
            const statuses = [
                'Logging into Farm to People...',
                'Found your account! Loading cart...',
                'Analyzing your produce selections...',
                'Creating personalized meal plans...',
                'Almost done...'
            ];

            let statusIndex = 0;
            const statusInterval = setInterval(() => {
                if (statusIndex < statuses.length) {
                    document.getElementById('loadingStatus').textContent = statuses[statusIndex];
                    statusIndex++;
                }
            }, 3000);

            try {
                // Get user phone (from localStorage or prompt)
                let userPhone = localStorage.getItem('userPhone');
                if (!userPhone) {
                    userPhone = prompt('Enter your phone number to analyze your cart:');
                    if (userPhone) {
                        localStorage.setItem('userPhone', userPhone);
                    }
                }
                
                // Start the actual analysis
                // Pass phone number to use stored credentials from database
                const response = await fetch('/api/analyze-cart', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({
                        phone: userPhone,
                        use_mock: false  // Set to true to use mock data for testing
                    })
                });

                const data = await response.json();
                clearInterval(statusInterval);

                if (data.success) {
                    showCartAnalysis(data.cart_data, data.swaps, data.addons);
                } else {
                    // For now, show mock data
                    showMockCartAnalysis();
                }
            } catch (error) {
                clearInterval(statusInterval);
                // Show mock data for testing
                showMockCartAnalysis();
            }
        }

        function showMockCartAnalysis() {
            // Real cart data from last week's scraping
            const realCartData = {
                individual_items: [
                    {name: "Pasture Raised Eggs", quantity: 1, unit: "1 dozen", price: "$7.49", type: "individual"},
                    {name: "Organic & Fair Trade Hass Avocados", quantity: 5, unit: "1 piece", price: "$12.50", type: "individual"},
                    {name: "Organic & Fair Trade Bananas (Ripe)", quantity: 1, unit: "1 bunch", price: "$2.49", type: "individual"}
                ],
                customizable_boxes: [
                    {
                        box_name: "The Cook's Box - Paleo",
                        selected_items: [
                            {name: "Boneless, Skinless Chicken Breast", unit: ".7-1lb", producer: "Locust Point Farm"},
                            {name: "Black Sea Bass", unit: "8.0 oz", producer: "Red's Best Seafood"},
                            {name: "Local Yellow Peaches", unit: "2 pieces", producer: "Lancaster Farm Fresh Cooperative"},
                            {name: "Organic Leaf Lettuce", unit: "1 head", producer: "Sun Sprout Farm"},
                            {name: "Mixed Cherry Tomatoes", unit: "1 pint", producer: "Eagle Road Farm"},
                            {name: "Lunchbox Peppers", unit: "12.0 oz", producer: "Sunny Harvest"},
                            {name: "Organic Italian Eggplant", unit: "1 piece", producer: "Lancaster Farm Fresh Cooperative"},
                            {name: "Unagi Cucumbers", unit: "2 pieces", producer: "Sunny Harvest"},
                            {name: "Organic Green Zucchini", unit: "2 pieces", producer: "Sun Sprout Farm"}
                        ],
                        available_alternatives: [
                            {name: "White Ground Turkey", unit: "1.0 Lbs", producer: "Koch's Turkey Farm"},
                            {name: "Pork Kielbasa", unit: "1 Lbs", producer: "Autumn's Harvest"},
                            {name: "Yellow Nectarines", unit: "2 pieces", producer: "Weaver's Orchard"},
                            {name: "Red Onions", unit: "2 Lbs", producer: "Dagele Brothers Produce"},
                            {name: "Yellow Onions", unit: "2.0 Lbs", producer: "Dagele Brothers Produce"}
                        ],
                        selected_count: 9,
                        alternatives_count: 10
                    }
                ],
                non_customizable_boxes: [
                    {
                        box_name: "Seasonal Fruit Medley",
                        selected_items: [
                            {name: "Prune Plums", unit: "1 Lbs"},
                            {name: "Honeycrisp Apples", unit: "2 pieces"},
                            {name: "Local Yellow Peaches", unit: "2 pieces"}
                        ],
                        selected_count: 3,
                        customizable: false
                    }
                ]
            };
            showCartAnalysis(realCartData);
        }

        // Helper function to determine item category
        function getItemCategory(itemName) {
            const name = itemName.toLowerCase();
            
            // Protein items
            if (name.includes('chicken') || name.includes('beef') || name.includes('turkey') || 
                name.includes('pork') || name.includes('sausage') || name.includes('fish') || 
                name.includes('salmon') || name.includes('bass') || name.includes('egg') ||
                name.includes('kielbasa')) {
                return 'protein';
            }
            
            // Dairy items
            if (name.includes('cheese') || name.includes('milk') || name.includes('yogurt') || 
                name.includes('butter') || name.includes('mozzarella') || name.includes('cheddar') ||
                name.includes('feta')) {
                return 'dairy';
            }
            
            // Fruit items
            if (name.includes('apple') || name.includes('banana') || name.includes('peach') || 
                name.includes('plum') || name.includes('nectarine') || name.includes('berry') ||
                name.includes('orange') || name.includes('lemon') || name.includes('lime') ||
                name.includes('avocado') || name.includes('melon')) {
                return 'fruit';
            }
            
            // Default to produce (vegetables, herbs, etc)
            return 'produce';
        }
        
        // Helper function to get category colors (minimal style like the reference image)
        function getCategoryColors(category) {
            const colors = {
                'protein': { bg: '#FFF0F0', text: '#D32F2F', border: '#FFCDD2' },
                'produce': { bg: '#F1F8F4', text: '#2E7D32', border: '#C8E6C9' },
                'dairy': { bg: '#E3F2FD', text: '#1976D2', border: '#BBDEFB' },
                'fruit': { bg: '#FFF8E1', text: '#F57C00', border: '#FFE082' },  // Changed to orange like pantry
                'pantry': { bg: '#FFF8E1', text: '#F57C00', border: '#FFE082' }
            };
            return colors[category] || colors['produce'];
        }
        
        function showCartAnalysis(cartData, swaps = [], addons = []) {
            currentState = 'complete';
            
            // Store cart analysis data in localStorage for persistence
            const analysisData = { cartData, swaps, addons, timestamp: Date.now() };
            localStorage.setItem('cartAnalysisData', JSON.stringify(analysisData));
            localStorage.setItem('cartAnalysisState', 'complete');
            document.getElementById('loadingSection').classList.remove('active');
            document.getElementById('cartAnalysisSection').classList.add('active');
            document.getElementById('headerSubtitle').textContent = 'Cart analysis complete';

            // Generate suggested meals using GPT-5 API instead of hardcoded suggestions
            generateMealSuggestionsFromAPI(cartData);

            // Show individual items with category tags
            if (cartData.individual_items && cartData.individual_items.length > 0) {
                // Update count
                document.getElementById('individualItemsCount').textContent = `(${cartData.individual_items.length} items)`;
                
                const individualHTML = cartData.individual_items.map(item => {
                    // Get category and colors
                    const category = getItemCategory(item.name);
                    const colors = getCategoryColors(category);
                    
                    // Format quantity properly
                    let quantityText = '';
                    if (item.unit.startsWith('1 ')) {
                        // Unit already contains "1 dozen", "1 piece", etc.
                        // Replace the "1" with actual quantity if different
                        if (item.quantity === 1) {
                            quantityText = item.unit;
                        } else {
                            // Replace "1 piece" with "5 pieces", "1 dozen" stays as is for quantity 1
                            const unitPart = item.unit.substring(2); // Remove "1 " prefix
                            // Pluralize if needed
                            if (item.quantity > 1 && unitPart === 'piece') {
                                quantityText = `${item.quantity} pieces`;
                            } else if (item.quantity > 1 && unitPart === 'bunch') {
                                quantityText = `${item.quantity} bunches`;
                            } else if (item.quantity > 1 && unitPart === 'head') {
                                quantityText = `${item.quantity} heads`;
                            } else {
                                quantityText = `${item.quantity} ${unitPart}`;
                            }
                        }
                    } else {
                        // Unit doesn't start with "1 ", use as is
                        quantityText = item.quantity > 1 ? `${item.quantity} √ó ${item.unit}` : item.unit;
                    }
                    
                    return `
                        <div class="cart-item" style="display: flex; align-items: center; padding: 12px; border-bottom: 1px solid #eee;">
                            <div class="item-details" style="flex: 1;">
                                <div style="display: flex; align-items: center; gap: 10px;">
                                    <div class="item-name">${item.name}</div>
                                    <div class="item-price" style="color: #2e7d32; font-weight: 600;">${item.price || 'N/A'}</div>
                                </div>
                                <div class="item-meta" style="color: #666; font-size: 14px;">${quantityText}</div>
                            </div>
                            <span class="category-tag" style="
                                background: white;
                                color: ${colors.text};
                                padding: 4px 12px;
                                border-radius: 16px;
                                font-size: 13px;
                                font-weight: 500;
                                min-width: 70px;
                                text-align: center;
                                border: 1.5px solid ${colors.border};
                                display: inline-block;
                            ">${category}</span>
                        </div>
                    `;
                }).join('');
                document.getElementById('individualItems').innerHTML = individualHTML;
            } else {
                document.getElementById('individualItemsSection').style.display = 'none';
            }

            // Show customizable boxes with category tags
            if (cartData.customizable_boxes && cartData.customizable_boxes.length > 0) {
                // Update count
                let totalItems = 0;
                cartData.customizable_boxes.forEach(box => {
                    totalItems += (box.selected_items ? box.selected_items.length : 0);
                });
                document.getElementById('customizableBoxesCount').textContent = `(${totalItems} items)`;
                
                const customizableHTML = cartData.customizable_boxes.map(box => `
                    <div style="margin-bottom: 20px;">
                        <div class="box-header">
                            <div class="box-name">${box.box_name}</div>
                            <div class="box-status">${box.alternatives_count} available alternatives</div>
                        </div>
                        <div class="item-grid">
                            ${box.selected_items.map(item => {
                                const category = getItemCategory(item.name);
                                const colors = getCategoryColors(category);
                                return `
                                    <div class="cart-item" style="display: flex; align-items: center; padding: 12px; border-bottom: 1px solid #eee;">
                                        <div class="item-details" style="flex: 1;">
                                            <div class="item-name">${item.name}</div>
                                            <div class="item-meta" style="color: #666; font-size: 14px;">${item.unit} ‚Ä¢ ${item.producer || 'Farm Fresh'}</div>
                                        </div>
                                        <span class="category-tag" style="
                                            background: white;
                                            color: ${colors.text};
                                            padding: 4px 12px;
                                            border-radius: 16px;
                                            font-size: 13px;
                                            font-weight: 500;
                                            min-width: 70px;
                                            text-align: center;
                                            border: 1.5px solid ${colors.border};
                                            display: inline-block;
                                        ">${category}</span>
                                    </div>
                                `;
                            }).join('')}
                        </div>
                    </div>
                `).join('');
                document.getElementById('customizableBoxes').innerHTML = customizableHTML;
            } else {
                document.getElementById('customizableBoxesSection').style.display = 'none';
            }

            // Show non-customizable boxes with category tags
            if (cartData.non_customizable_boxes && cartData.non_customizable_boxes.length > 0) {
                // Update count
                let totalItems = 0;
                cartData.non_customizable_boxes.forEach(box => {
                    totalItems += (box.selected_items ? box.selected_items.length : 0);
                });
                document.getElementById('fixedBoxesCount').textContent = `(${totalItems} items)`;
                
                const nonCustomizableHTML = cartData.non_customizable_boxes.map(box => `
                    <div style="margin-bottom: 20px;">
                        <div class="box-header">
                            <div class="box-name">${box.box_name}</div>
                            <div class="box-status">Fixed selection</div>
                        </div>
                        <div class="item-grid">
                            ${box.selected_items.map(item => {
                                const category = getItemCategory(item.name);
                                const colors = getCategoryColors(category);
                                return `
                                    <div class="cart-item" style="display: flex; align-items: center; padding: 12px; border-bottom: 1px solid #eee;">
                                        <div class="item-details" style="flex: 1;">
                                            <div class="item-name">${item.name}</div>
                                            <div class="item-meta" style="color: #666; font-size: 14px;">${item.unit}</div>
                                        </div>
                                        <span class="category-tag" style="
                                            background: white;
                                            color: ${colors.text};
                                            padding: 4px 12px;
                                            border-radius: 16px;
                                            font-size: 13px;
                                            font-weight: 500;
                                            min-width: 70px;
                                            text-align: center;
                                            border: 1.5px solid ${colors.border};
                                            display: inline-block;
                                        ">${category}</span>
                                    </div>
                                `;
                            }).join('')}
                        </div>
                    </div>
                `).join('');
                document.getElementById('nonCustomizableBoxes').innerHTML = nonCustomizableHTML;
            } else {
                document.getElementById('nonCustomizableBoxesSection').style.display = 'none';
            }

            // Show AI-generated swaps (2025-08-29: Using GPT-5 generated swaps)
            if (swaps && swaps.length > 0) {
                const swapsHTML = swaps.map(swap => `
                    <div class="swap-suggestion">
                        <div class="swap-text">Swap ${swap.from} ‚Üí ${swap.to}</div>
                        <div class="swap-reason" style="font-size: 12px; color: #666; margin-top: 4px;">${swap.reason}</div>
                    </div>
                `).join('');
                document.getElementById('suggestedSwaps').innerHTML = swapsHTML;
            } else {
                document.getElementById('suggestedSwaps').innerHTML = '<div style="color: #666; padding: 10px;">No swaps needed - your selections look great!</div>';
            }

            // Show AI-generated fresh add-ons (2025-08-29: Fresh ingredients only, no pantry staples)
            if (addons && addons.length > 0) {
                const addonsHTML = addons.map(addon => {
                    // Determine category and color using the same helper function
                    const category = addon.category || 'produce';
                    const colors = getCategoryColors(category);
                    
                    return `
                        <div class="addon-item" style="display: flex; align-items: center; padding: 12px; border-bottom: 1px solid #eee;">
                            <div class="item-details" style="flex: 1;">
                                <div style="display: flex; align-items: center; gap: 10px;">
                                    <div class="item-name" style="font-weight: 600;">${addon.item}</div>
                                    <div class="item-price" style="color: #2e7d32; font-weight: 600;">${addon.price || '$3.99'}</div>
                                </div>
                                <div class="item-meta" style="color: #666; font-size: 14px; margin-top: 2px;">${addon.reason}</div>
                            </div>
                            <span class="category-tag" style="
                                background: white;
                                color: ${colors.text};
                                padding: 4px 12px;
                                border-radius: 16px;
                                font-size: 13px;
                                font-weight: 500;
                                min-width: 70px;
                                text-align: center;
                                border: 1.5px solid ${colors.border};
                                display: inline-block;
                            ">${category}</span>
                        </div>
                    `;
                }).join('');
                document.getElementById('recommendedAddons').innerHTML = addonsHTML;
            } else {
                // No addons suggested
                document.getElementById('recommendedAddons').innerHTML = '<div style="color: #666; padding: 10px;">Your cart is complete!</div>';
            }
        }

        function generateMealSuggestions(cartData) {
            // Analyze cart contents to suggest meals
            const proteins = [];
            const vegetables = [];
            
            // Extract proteins and vegetables from cart
            cartData.customizable_boxes?.forEach(box => {
                box.selected_items.forEach(item => {
                    if (item.name.includes('Chicken') || item.name.includes('Bass') || item.name.includes('Turkey')) {
                        proteins.push(item.name);
                    }
                    if (item.name.includes('Lettuce') || item.name.includes('Tomatoes') || 
                        item.name.includes('Peppers') || item.name.includes('Zucchini') || 
                        item.name.includes('Eggplant') || item.name.includes('Cucumbers')) {
                        vegetables.push(item.name);
                    }
                });
            });

            // Generate meal suggestions prioritizing dinner, then other meals
            const mealSuggestions = [
                {
                    name: "Pan-Seared Chicken + Cherry Tomato Salad",
                    time: 20,
                    protein: 35,
                    type: "Dinner",
                    servings: 2,
                    priority: 1
                },
                {
                    name: "Black Sea Bass + Grilled Vegetables",
                    time: 25,
                    protein: 28,
                    type: "Dinner", 
                    servings: 2,
                    priority: 1
                },
                {
                    name: "Stuffed Eggplant + Zucchini",
                    time: 35,
                    protein: 12,
                    type: "Lunch",
                    servings: 4,
                    priority: 2
                },
                {
                    name: "Avocado + Egg Breakfast Bowl",
                    time: 10,
                    protein: 18,
                    type: "Breakfast",
                    servings: 1,
                    priority: 3
                },
                {
                    name: "Cucumber + Pepper Fresh Salad",
                    time: 5,
                    protein: 6,
                    type: "Side",
                    servings: 2,
                    priority: 4
                }
            ];

            // Sort by priority (dinner first) and return top 4
            return mealSuggestions.sort((a, b) => a.priority - b.priority).slice(0, 4);
        }

        // Refresh meals button handler
        document.addEventListener('DOMContentLoaded', () => {
            const refreshButton = document.getElementById('refreshMeals');
            if (refreshButton) {
                refreshButton.addEventListener('click', async () => {
                    if (refreshesLeft > 0) {
                        // Disable button during refresh
                        refreshButton.disabled = true;
                        refreshButton.innerHTML = '‚è≥ Generating new meals...';
                        
                        try {
                            // Call API to regenerate meals
                            const response = await fetch('/api/refresh-meals', {
                                method: 'POST',
                                headers: {'Content-Type': 'application/json'},
                                body: JSON.stringify({
                                    cart_data: mealPlanData,
                                    phone: localStorage.getItem('userPhone')
                                })
                            });
                            
                            const data = await response.json();
                            
                            if (data.success) {
                                // Update meal suggestions
                                updateMealSuggestions(data.meals);
                                
                                // Decrement refresh count
                                refreshesLeft--;
                                localStorage.setItem('refreshesLeft', refreshesLeft);
                                
                                // Update button
                                if (refreshesLeft > 0) {
                                    refreshButton.disabled = false;
                                    refreshButton.innerHTML = `üîÑ Try Different Meals (${refreshesLeft} left)`;
                                } else {
                                    refreshButton.disabled = true;
                                    refreshButton.innerHTML = 'üîÑ No refreshes left';
                                    refreshButton.style.background = '#dee2e6';
                                }
                            } else {
                                // Re-enable on error
                                refreshButton.disabled = false;
                                refreshButton.innerHTML = `üîÑ Try Different Meals (${refreshesLeft} left)`;
                                alert('Failed to generate new meals. Please try again.');
                            }
                        } catch (error) {
                            console.error('Error refreshing meals:', error);
                            refreshButton.disabled = false;
                            refreshButton.innerHTML = `üîÑ Try Different Meals (${refreshesLeft} left)`;
                        }
                    }
                });
            }
            
            // Load refresh count from localStorage
            const savedRefreshes = localStorage.getItem('refreshesLeft');
            if (savedRefreshes !== null) {
                refreshesLeft = parseInt(savedRefreshes);
                const refreshSpan = document.getElementById('refreshCount');
                if (refreshSpan) {
                    refreshSpan.textContent = refreshesLeft;
                }
            }
        });

        function updateMealSuggestions(meals) {
            // Update the meal suggestions container with new meals
            const container = document.getElementById('mealSuggestionsContainer');
            if (container && meals) {
                // Clear existing meals
                container.innerHTML = '';
                
                // Add new meals with enhanced information
                meals.forEach((meal, index) => {
                    const mealCard = document.createElement('div');
                    mealCard.className = 'meal-card';
                    
                    // Build ingredients list if available
                    const ingredientsText = meal.ingredients_used && meal.ingredients_used.length > 0 
                        ? `<div class="meal-ingredients">Uses: ${meal.ingredients_used.slice(0,3).join(', ')}</div>` 
                        : '';
                    
                    // Add note if present
                    const noteText = meal.note ? `<div class="meal-note">üí° ${meal.note}</div>` : '';
                    
                    // Show how many dinners this makes
                    const servingsText = meal.makes_x_dinners || `Serves ${meal.servings || 2}`;
                    
                    mealCard.innerHTML = `
                        <div class="meal-header">
                            <span class="meal-name">${meal.name}</span>
                            <span class="meal-meta">${meal.time} ‚Ä¢ ${meal.protein}g protein ‚Ä¢ ${meal.type || 'Dinner'}</span>
                        </div>
                        <div class="meal-servings">${servingsText}</div>
                        ${ingredientsText}
                        ${noteText}
                    `;
                    container.appendChild(mealCard);
                });
            }
        }

        async function generateMealSuggestionsFromAPI(cartData) {
            try {
                console.log('üçΩÔ∏è Calling GPT-5 API for meal suggestions...');
                
                // Show loading state
                document.getElementById('suggestedMeals').innerHTML = `
                    <div style="text-align: center; padding: 20px; color: #666;">
                        ü§ñ GPT-5 is creating personalized meal suggestions...
                    </div>
                `;
                
                const response = await fetch('/api/refresh-meals', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({
                        cart_data: cartData,
                        phone: localStorage.getItem('userPhone')
                    })
                });
                
                const data = await response.json();
                
                if (data.success && data.meals && data.meals.length > 0) {
                    console.log('‚úÖ Got meal suggestions from GPT-5:', data.meals);
                    updateMealSuggestions(data.meals);
                } else {
                    console.error('‚ùå Meal generation failed:', data.error || 'Unknown error');
                    
                    // Show clear error message
                    document.getElementById('suggestedMeals').innerHTML = `
                        <div style="background: #fee; border: 1px solid #fcc; border-radius: 8px; padding: 16px; margin: 8px 0;">
                            <div style="color: #d00; font-weight: 600; margin-bottom: 8px;">
                                ‚ö†Ô∏è Meal Generation Error
                            </div>
                            <div style="color: #800; font-size: 14px;">
                                ${data.error || 'Unable to generate meal suggestions'}
                            </div>
                            ${data.debug_info ? `
                                <div style="margin-top: 12px; padding-top: 12px; border-top: 1px solid #fcc;">
                                    <div style="font-size: 12px; color: #666;">Debug Info:</div>
                                    <div style="font-size: 12px; color: #666; margin-top: 4px;">
                                        Proteins: ${data.debug_info.proteins_found?.length || 0} items<br>
                                        Vegetables: ${data.debug_info.vegetables_found?.length || 0} items<br>
                                        Error: ${data.debug_info.error_message || 'Unknown'}
                                    </div>
                                </div>
                            ` : ''}
                        </div>
                    `;
                    
                    if (data.debug_info) {
                        console.log('Debug information:', data.debug_info);
                    }
                }
            } catch (error) {
                console.error('Error generating meal suggestions:', error);
                // Show error state
                document.getElementById('suggestedMeals').innerHTML = `
                    <div style="text-align: center; padding: 20px; color: #666;">
                        Error generating meal suggestions. Please try refreshing.
                    </div>
                `;
            }
        }

        async function refreshCartData() {
            // Clear stored data to force fresh analysis
            localStorage.removeItem('cartAnalysisData');
            localStorage.removeItem('cartAnalysisState');
            
            const button = document.getElementById('refreshCartButton');
            const originalText = button.innerHTML;
            
            try {
                button.disabled = true;
                button.innerHTML = '‚è≥ Refreshing...';
                
                // Re-run cart analysis
                await startAnalysis();
                
            } catch (error) {
                console.error('Error refreshing cart:', error);
                alert('Failed to refresh cart data. Please try again.');
            } finally {
                button.disabled = false;
                button.innerHTML = originalText;
            }
        }
        
        function updateMealSuggestions(meals) {
            const mealsHTML = meals.map((meal, index) => `
                <div class="cart-item" style="background: #f0f8f0; border-left: 3px solid #4169E1;">
                    <div class="item-details">
                        <div class="item-name" style="color: #4169E1; font-weight: 600;">${meal.name}</div>
                        <div class="item-meta">${meal.time} ‚Ä¢ ${meal.protein}g protein ‚Ä¢ ${meal.type || 'Dinner'}</div>
                    </div>
                    <div style="font-size: 12px; color: #6c757d;">Serves ${meal.servings || 2}</div>
                </div>
            `).join('');
            document.getElementById('suggestedMeals').innerHTML = mealsHTML;
        }

        function switchTab(tab, element) {
            // Update active tab
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            element.classList.add('active');

            // Hide all sections
            document.querySelectorAll('.section').forEach(s => s.classList.remove('active'));

            // Show the right section based on state and tab
            if (tab === 'cart') {
                // Cart tab shows the current cart analysis
                if (currentState === 'complete') {
                    document.getElementById('cartAnalysisSection').classList.add('active');
                } else if (currentState === 'loading') {
                    document.getElementById('loadingSection').classList.add('active');
                } else {
                    document.getElementById('startSection').classList.add('active');
                }
            } else if (tab === 'meals') {
                // Meals tab shows meal suggestions
                document.getElementById('mealsSection').classList.add('active');
            } else if (tab === 'settings') {
                // Settings redirects to separate page (handled by href)
                document.getElementById('settingsSection').classList.add('active');
            }
        }

        function showAddToHomeScreen() {
            // iOS Safari
            if (navigator.userAgent.match(/iPhone|iPad|iPod/)) {
                alert('Tap the Share button (‚ÜóÔ∏è) at the bottom of Safari, then tap "Add to Home Screen"');
            } 
            // Android Chrome
            else if (navigator.userAgent.match(/Android/)) {
                alert('Tap the menu (‚ãÆ) in Chrome, then tap "Add to Home screen"');
            } 
            else {
                alert('Use your browser\'s menu to add this page to your home screen');
            }
        }

        // Save credentials when they complete onboarding (called from onboarding.js)
        window.saveUserCredentials = function(email, password) {
            localStorage.setItem('ftpEmail', email);
            localStorage.setItem('ftpPassword', password);
        }
    </script>
</body>
</html>