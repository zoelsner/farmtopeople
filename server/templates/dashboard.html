<!DOCTYPE html>
<!--
    =========================================================================
    FARM TO PEOPLE DASHBOARD - MAIN USER INTERFACE
    =========================================================================

    FILE STRUCTURE:
    ---------------
    1. HEAD (Lines 1-1050)
       - Meta tags for PWA support
       - CSS imports (fitbod_meal_planning.css)
       - Inline styles for light theme overrides
       - Navigation tabs and loading states

    2. HTML STRUCTURE (Lines 1050-1450)
       - Header with title and delivery date
       - Bottom navigation tabs (Cart, Meals, Settings)
       - Cart Tab: Analysis screen, loading states, results display
       - Meals Tab: Weekly calendar, drag-and-drop meal planning
       - Settings Tab: User preferences (NOW OPENS AS MODAL - PWA FIX)

    3. JAVASCRIPT SECTIONS (Lines 1450-3500+)
       - Cart Analysis Functions (Lines 1450-2000)
         * analyzeCart() - Main cart scraping function
         * showCartAnalysis() - Display cart results
         * generateMealSuggestions() - AI meal recommendations

       - Tab Navigation (Lines 2448-2515)
         * switchTab() - Handle tab switching (Settings ‚Üí Modal)
         * openSettingsModal() - NEW: Open settings in overlay (Line 2516)
         * closeSettingsModal() - NEW: Close settings overlay (Line 2708)

       - Meal Calendar (Lines 2680-3000)
         * initMealCalendar() - Setup weekly view
         * Drag and drop handlers
         * Meal regeneration

       - Settings Management (Lines 3340-3500)
         * loadUserSettings() - Fetch user preferences
         * displaySettings() - Render settings UI
         * savePreferences() - Update user data

    RECENT CHANGES (Sept 2025):
    ---------------------------
    - Settings tab now opens as modal overlay (PWA navigation fix)
    - Added openSettingsModal() and closeSettingsModal() functions
    - Settings no longer causes page refresh in PWA mode

    KEY FEATURES:
    -------------
    - Progressive Web App (PWA) compatible
    - Real-time cart analysis from Farm to People
    - AI-powered meal suggestions based on cart contents
    - Drag-and-drop meal calendar for weekly planning
    - User preference management
    - Offline-capable with localStorage fallbacks

    API ENDPOINTS USED:
    -------------------
    - POST /api/analyze-cart - Scrape and analyze FTP cart
    - GET /api/settings/{phone} - Load user preferences
    - POST /api/update-preferences - Save preference changes
    - POST /api/generate-weekly-meals - Create meal plan
    - GET /api/meal-plans/{phone}/{week} - Load saved meal plans

    =========================================================================
-->
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Your Meal Plan - Farm to People</title>
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black">
    
    <!-- Professional Fitbod CSS for styling only -->
    <link rel="stylesheet" href="/static/css/fitbod_meal_planning.css">
    
    <style>
        /* Override with light theme colors */
        :root {
            --bg-primary: #f8f9fa !important;
            --bg-secondary: #ffffff !important;
            --bg-card: #ffffff !important;
            --border-subtle: rgba(0, 0, 0, 0.08) !important;
            --text-primary: #1a1a1a !important;
            --text-secondary: #666666 !important;
            --text-tertiary: #999999 !important;
            --accent-blue: #007AFF !important;
            --accent-green: #28a745 !important;
            --accent-red: #dc3545 !important;
            --shadow-card: 0 2px 12px rgba(0, 0, 0, 0.08) !important;
            --shadow-hover: 0 4px 20px rgba(0, 0, 0, 0.12) !important;
        }
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background-color: var(--bg-primary);
            color: var(--text-primary);
            padding-bottom: 80px; /* Space for bottom tabs */
        }

        /* Top Header */
        .header {
            background: white;
            padding: 20px;
            border-bottom: 1px solid #e9ecef;
            position: sticky;
            top: 0;
            z-index: 100;
        }

        .header h1 {
            font-size: 24px;
            color: #212529;
            margin-bottom: 4px;
        }

        .header .subtitle {
            color: #6c757d;
            font-size: 14px;
        }

        /* Main Content Area */
        .content {
            padding: 20px;
            max-width: 600px;
            margin: 0 auto;
            min-height: calc(100vh - 200px);
        }

        /* Start Screen - Before Analysis */
        .start-screen {
            text-align: center;
            padding: 40px 20px;
        }

        .start-icon {
            font-size: 48px;
            margin-bottom: 20px;
        }

        .start-title {
            font-size: 24px;
            font-weight: 600;
            color: #212529;
            margin-bottom: 8px;
        }

        .start-description {
            font-size: 16px;
            color: #6c757d;
            margin-bottom: 24px;
            line-height: 1.4;
        }

        .analyze-button {
            background: #28a745;
            color: white;
            border: none;
            padding: 18px 40px;
            font-size: 18px;
            font-weight: 600;
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.2s ease;
            display: inline-block;
        }

        .analyze-button:hover {
            background: #218838;
            transform: translateY(-2px);
        }

        .analyze-button:active {
            transform: translateY(0);
        }

        /* Loading State */
        .loading-screen {
            text-align: center;
            padding: 60px 20px;
            display: none;
        }

        .loading-animation {
            width: 80px;
            height: 80px;
            margin: 0 auto 24px;
            border: 4px solid #e9ecef;
            border-top: 4px solid #28a745;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .loading-title {
            font-size: 24px;
            font-weight: 600;
            color: #212529;
            margin-bottom: 12px;
        }

        .loading-status {
            font-size: 16px;
            color: #6c757d;
            margin-bottom: 8px;
        }

        .loading-tip {
            background: #e3f2fd;
            border-radius: 12px;
            padding: 20px;
            margin-top: 32px;
            max-width: 400px;
            margin-left: auto;
            margin-right: auto;
        }

        .loading-tip h3 {
            font-size: 16px;
            color: #1976d2;
            margin-bottom: 12px;
        }

        .loading-tip p {
            font-size: 14px;
            color: #495057;
            line-height: 1.4;
            margin-bottom: 16px;
        }

        .home-screen-prompt {
            background: white;
            border: 2px solid #1976d2;
            border-radius: 8px;
            padding: 12px;
            font-size: 14px;
            color: #1976d2;
            font-weight: 500;
            cursor: pointer;
            text-decoration: none;
            display: inline-block;
        }

        /* Cart Analysis Display */
        .cart-analysis {
            display: none;
        }

        .cart-section {
            background: white;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
        }

        .section-header {
            font-size: 18px;
            font-weight: 600;
            color: #212529;
            margin-bottom: 16px;
            padding-bottom: 8px;
            border-bottom: 2px solid #e9ecef;
        }

        .item-grid {
            display: grid;
            gap: 12px;
        }

        .cart-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px;
            background: #f8f9fa;
            border-radius: 8px;
        }

        .item-details {
            flex: 1;
        }

        .item-name {
            font-size: 14px;
            font-weight: 600;
            color: #4169E1; /* Penny blue for item names */
            margin-bottom: 4px;
        }

        .item-meta {
            font-size: 12px;
            color: #6c757d;
        }

        .item-price {
            font-size: 14px;
            font-weight: 600;
            color: #28a745;
        }

        .box-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
        }

        .box-name {
            font-size: 16px;
            font-weight: 600;
            color: #212529;
        }

        .box-status {
            font-size: 12px;
            color: #6c757d;
            background: #e9ecef;
            padding: 4px 8px;
            border-radius: 4px;
        }

        .swap-suggestion {
            background: #fff3cd;
            border-left: 4px solid #ffc107;
            padding: 12px;
            margin-bottom: 12px;
            border-radius: 4px;
        }

        .swap-text {
            font-size: 14px;
            color: #856404;
        }

        .addon-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px;
            background: #d4edda;
            border-radius: 8px;
            margin-bottom: 8px;
        }

        /* Bottom Tab Navigation */
        .bottom-tabs {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: #4169E1; /* Penny blue background */
            border-top: 1px solid #3557d1;
            display: flex;
            justify-content: space-around;
            padding: 8px 0;
            padding-bottom: calc(8px + env(safe-area-inset-bottom)); /* iPhone safe area */
            z-index: 1000;
        }

        .tab {
            flex: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 8px;
            text-decoration: none;
            color: rgba(255, 255, 255, 0.7); /* White text, semi-transparent */
            transition: all 0.2s ease;
        }

        .tab.active {
            color: white; /* Pure white when active */
        }

        .tab-icon {
            width: 20px;
            height: 20px;
            margin-bottom: 4px;
            fill: currentColor;
        }

        .tab-label {
            font-size: 11px;
            font-weight: 500;
        }

        /* 2D SVG Icons */
        .icon-home {
            fill: currentColor;
        }

        .icon-cart {
            fill: currentColor;
        }

        .icon-settings {
            fill: currentColor;
        }

        /* Tighter layout */
        .content {
            padding: 16px;
            max-width: 600px;
            margin: 0 auto;
            min-height: calc(100vh - 180px);
        }

        .cart-section {
            background: white;
            border-radius: 8px;
            padding: 16px;
            margin-bottom: 16px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.05);
        }

        .section-header {
            font-size: 16px;
            font-weight: 600;
            color: #212529;
            margin-bottom: 12px;
            padding-bottom: 6px;
            border-bottom: 1px solid #e9ecef;
        }

        .item-grid {
            display: grid;
            gap: 8px;
        }

        .cart-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px;
            background: #f8f9fa;
            border-radius: 6px;
        }

        /* Hide sections by default */
        .section {
            display: none;
        }

        .section.active {
            display: block;
        }

        /* Responsive adjustments */
        @media (max-width: 380px) {
            .start-title {
                font-size: 24px;
            }
            
            .start-description {
                font-size: 16px;
            }
        }

        /* ===== MEAL CALENDAR STYLES ===== */
        
        .calendar-container {
            display: grid;
            grid-template-columns: 1fr auto;
            gap: 20px;
            margin-top: 20px;
        }
        
        .calendar-grid {
            display: flex;
            flex-direction: column;
            gap: 12px;
            min-height: 300px;
        }
        
        .day-column {
            background: white;
            border-radius: 12px;
            border: 2px solid #f0f0f0;
            overflow: hidden;
            transition: all 0.2s ease;
        }
        
        .day-column.drag-over {
            border-color: #28a745;
            background: #f8fff9;
            transform: scale(1.02);
        }
        
        .day-header {
            padding: 20px 0 12px 0;
            text-align: left;
            border-bottom: 1px solid #f1f5f9;
        }

        .day-header h3 {
            font-size: 18px;
            font-weight: 600;
            color: #1e293b;
            margin: 0 0 4px 0;
        }
        
        .day-date {
            font-size: 14px;
            color: #94a3b8;
            font-weight: normal;
        }
        
        .meal-slot {
            padding: 20px 0;
            min-height: 160px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .add-meal-prompt {
            text-align: center;
            color: #94a3b8;
            cursor: pointer;
            padding: 32px 20px;
            border: 1px dashed #d1d5db;
            border-radius: 12px;
            width: 100%;
            transition: all 0.2s ease;
        }

        .add-meal-prompt:hover {
            border-color: #3b82f6;
            color: #3b82f6;
            background: #f8fafc;
        }

        .add-icon {
            display: block;
            font-size: 20px;
            margin-bottom: 8px;
        }
        
        /* Meal Cards - Clean Minimal Design */
        .meal-card {
            background: white;
            border: 1px solid #e5e7eb;
            border-radius: 12px;
            padding: 20px;
            cursor: pointer;
            transition: all 0.2s ease;
            width: 100%;
            position: relative;
        }

        .meal-card:hover {
            border-color: #3b82f6;
            box-shadow: 0 4px 12px rgba(59, 130, 246, 0.15);
        }

        .meal-card.dragging {
            opacity: 0.8;
            transform: scale(0.95);
            z-index: 1000;
            box-shadow: 0 8px 24px rgba(0, 0, 0, 0.15);
        }
        
        .meal-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 12px;
        }

        .meal-name {
            font-size: 16px;
            font-weight: 600;
            color: #1a1a1a;
            line-height: 1.4;
        }
        
        .protein-badge {
            background: #f1f5f9;
            color: #475569;
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 500;
            white-space: nowrap;
        }
        
        .meal-details {
            display: flex;
            gap: 12px;
            margin-bottom: 16px;
            font-size: 14px;
            color: #64748b;
        }
        
        .ingredients-used {
            font-size: 11px;
            color: #6c757d;
            margin-bottom: 8px;
        }
        
        .ingredient-chip {
            display: inline-block;
            background: #f8f9fa;
            padding: 2px 6px;
            border-radius: 4px;
            font-size: 10px;
            margin-right: 4px;
            margin-bottom: 2px;
        }
        
        .meal-actions {
            display: flex;
            gap: 8px;
            justify-content: flex-end;
        }
        
        .meal-action-btn {
            background: none;
            border: none;
            border-radius: 6px;
            padding: 6px 10px;
            font-size: 14px;
            cursor: pointer;
            transition: all 0.2s ease;
            color: #64748b;
        }

        .meal-action-btn:hover {
            background: #f1f5f9;
            color: #3b82f6;
        }

        .meal-action-btn.regenerate {
            color: #64748b;
        }

        .meal-action-btn.regenerate:hover {
            background: #f1f5f9;
            color: #3b82f6;
        }
        
        .meal-action-btn.remove {
            color: #94a3b8;
        }

        .meal-action-btn.remove:hover {
            background: #fef2f2;
            color: #ef4444;
        }
        
        /* Ingredient Panel */
        .ingredient-panel {
            width: 200px;
            background: white;
            border-radius: 12px;
            border: 1px solid #e9ecef;
            padding: 16px;
            height: fit-content;
            position: sticky;
            top: 20px;
        }
        
        .ingredient-panel h3 {
            font-size: 16px;
            font-weight: 600;
            color: #495057;
            margin-bottom: 16px;
        }
        
        .ingredient-item {
            margin-bottom: 12px;
            padding-bottom: 12px;
            border-bottom: 1px solid #f8f9fa;
        }
        
        .ingredient-item:last-child {
            border-bottom: none;
            margin-bottom: 0;
        }
        
        .ingredient-name {
            font-size: 13px;
            font-weight: 500;
            color: #495057;
            margin-bottom: 4px;
        }
        
        .ingredient-progress {
            width: 100%;
            height: 6px;
            background: #f8f9fa;
            border-radius: 3px;
            overflow: hidden;
            margin-bottom: 4px;
        }
        
        .ingredient-progress-bar {
            height: 100%;
            background: linear-gradient(90deg, #28a745 0%, #20c997 100%);
            transition: width 0.3s ease;
        }
        
        .ingredient-status {
            font-size: 11px;
            color: #6c757d;
            display: flex;
            justify-content: space-between;
        }
        
        /* Navigation Buttons */
        .nav-button {
            background: white;
            border: 1px solid #dee2e6;
            border-radius: 6px;
            padding: 8px 12px;
            font-size: 16px;
            cursor: pointer;
            transition: all 0.2s ease;
        }
        
        .nav-button:hover {
            background: #f8f9fa;
            border-color: #28a745;
        }
        
        .pdf-button {
            background: #007bff;
            color: white;
            border: none;
            border-radius: 6px;
            padding: 8px 12px;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s ease;
        }
        
        .pdf-button:hover {
            background: #0056b3;
        }
        
        .auto-fill-button {
            width: 100%;
            background: #28a745;
            color: white;
            border: none;
            border-radius: 6px;
            padding: 10px;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            margin-top: 16px;
        }
        
        .auto-fill-button:hover {
            background: #218838;
        }
        
        /* Loading, Error, Empty States */
        .loading-state, .error-state, .empty-state {
            text-align: center;
            padding: 40px 20px;
        }

        /* Simple Meal Card Styling */
        .meal-card-container {
            padding: 20px;
            display: block !important;
            visibility: visible !important;
            opacity: 1 !important;
            height: auto !important;
        }

        .simple-meal-card {
            background: white;
            border: 1px solid #e5e7eb;
            border-radius: 12px;
            padding: 32px;
            margin: 0 auto;
            max-width: 500px;
            text-align: left;
            display: block !important; /* Force visibility */
            visibility: visible !important;
            opacity: 1 !important;
        }

        .meal-card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 24px;
            padding-bottom: 20px;
            border-bottom: 1px solid #f1f5f9;
        }

        .meal-card-header h3 {
            margin: 0;
            font-size: 22px;
            font-weight: 600;
            color: #1a1a1a;
        }

        .meal-card-header span {
            background: #f1f5f9;
            color: #475569;
            padding: 6px 12px;
            border-radius: 12px;
            font-size: 14px;
            font-weight: 500;
        }

        .meal-ingredients h4 {
            margin: 0 0 16px 0;
            font-size: 18px;
            font-weight: 600;
            color: #1e293b;
        }

        .ingredients-list {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-bottom: 32px;
        }

        .ingredient-tag {
            background: #f8fafc;
            border: 1px solid #e2e8f0;
            padding: 8px 14px;
            border-radius: 12px;
            font-size: 14px;
            color: #475569;
        }

        .meal-actions {
            display: flex;
            gap: 12px;
            flex-wrap: wrap;
        }

        .regenerate-button {
            background: #3b82f6;
            color: white;
            border: none;
            padding: 14px 24px;
            border-radius: 12px;
            font-size: 15px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s ease;
            flex: 1;
        }

        .regenerate-button:hover {
            background: #2563eb;
            transform: translateY(-1px);
        }

        .regenerate-button:disabled {
            background: #94a3b8;
            cursor: not-allowed;
            transform: none;
        }
        
        .spinner {
            width: 32px;
            height: 32px;
            border: 3px solid #f1f5f9;
            border-top: 3px solid #3b82f6;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .error-icon, .empty-icon {
            font-size: 48px;
            margin-bottom: 16px;
        }
        
        .retry-button {
            background: #007bff;
            color: white;
            border: none;
            border-radius: 6px;
            padding: 10px 20px;
            font-size: 14px;
            cursor: pointer;
            margin-top: 12px;
        }
        
        /* Bottom Navigation Tabs - Mobile-first Design */
        .bottom-nav {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: white;
            border-top: 1px solid #e9ecef;
            display: flex;
            justify-content: space-around;
            padding: 8px 0;
            z-index: 1000;
            box-shadow: 0 -2px 10px rgba(0, 0, 0, 0.05);
        }
        
        .nav-tab {
            flex: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 8px 0;
            cursor: pointer;
            transition: all 0.2s ease;
            text-decoration: none;
            color: #6c757d;
            position: relative;
        }
        
        .nav-tab-icon {
            width: 24px;
            height: 24px;
            margin-bottom: 4px;
            transition: all 0.2s ease;
        }
        
        .nav-tab svg {
            width: 24px;
            height: 24px;
        }
        
        .nav-tab-label {
            font-size: 12px;
            font-weight: 500;
            transition: all 0.2s ease;
        }
        
        .nav-tab.active {
            color: #007AFF;
        }
        
        .nav-tab.active .nav-tab-icon {
            transform: scale(1.1);
        }
        
        .nav-tab::before {
            content: '';
            position: absolute;
            top: -1px;
            left: 20%;
            right: 20%;
            height: 3px;
            background: #007AFF;
            opacity: 0;
            transition: all 0.2s ease;
        }
        
        .nav-tab.active::before {
            opacity: 1;
            left: 10%;
            right: 10%;
        }
        
        /* Tab Content Areas */
        .tab-content {
            display: none;
            animation: fadeIn 0.3s ease;
        }
        
        .tab-content.active {
            display: block;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        /* Adjust main content for bottom nav */
        .content {
            padding-bottom: 80px; /* Space for bottom nav */
        }
        
        /* Mobile Responsive */
        @media (max-width: 768px) {
            .calendar-container {
                grid-template-columns: 1fr;
            }
            
            .calendar-grid {
                flex-direction: column;
                gap: 8px;
            }
            
            .ingredient-panel {
                width: 100%;
                position: static;
            }
            
            .day-column {
                margin-bottom: 8px;
            }
            
            .meal-slot {
                min-height: 120px;
                padding: 12px;
            }
            
            .calendar-header > div {
                flex-direction: column;
                gap: 12px;
                align-items: flex-start;
            }
        }
    </style>
</head>
<body>
    <div class="header">
        <div style="display: flex; justify-content: space-between; align-items: center;">
            <div>
                <h1>Cart Analysis</h1>
                <p class="subtitle" id="headerSubtitle">Ready to analyze your cart</p>
            </div>
            <div id="deliveryDate" style="display: none; text-align: right;">
                <div style="color: #28a745; font-weight: 600; font-size: 16px;" id="deliveryDateText"></div>
                <div style="color: #6c757d; font-size: 12px;">Delivery Date</div>
            </div>
        </div>
    </div>

    <div class="content">
        <!-- Box Tab Content -->
        <div class="tab-content active" id="boxTab">
            <!-- Start Screen - Shows First -->
            <div class="start-screen section active" id="startSection">
            <div class="start-icon">üì¶</div>
            <h2 class="start-title">Cart Analysis</h2>
            <p class="start-description">
                See what's in your Farm to People cart, suggested swaps, and add-ons.
            </p>
            <button class="analyze-button" onclick="startAnalysis()">
                Analyze My Cart
            </button>
        </div>

        <!-- Loading Screen - Shows During Analysis -->
        <div class="loading-screen section" id="loadingSection">
            <div class="loading-animation"></div>
            <h2 class="loading-title">Analyzing Your Cart</h2>
            <p class="loading-status" id="loadingStatus">Logging into Farm to People...</p>
            
            <div class="loading-tip">
                <h3>While you wait (20-30 seconds)</h3>
                <p>Add this page to your home screen for easy access:</p>
                <button class="home-screen-prompt" onclick="showAddToHomeScreen()">
                    Add to Home Screen
                </button>
            </div>
        </div>

        <!-- Cart Analysis Display - Shows After Analysis -->
        <div class="cart-analysis section" id="cartAnalysisSection">
            <!-- Suggested Meals - TOP PRIORITY -->
            <div class="cart-section" id="suggestedMealsSection">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px;">
                    <h3 class="section-header" style="margin: 0;">Suggested Meals</h3>
                    <div style="display: flex; gap: 8px;">
                        <button id="refreshSuggestionsButton" onclick="refreshSuggestions()" 
                                style="background: #34C759; color: white; border: none; border-radius: 8px; padding: 8px 16px; font-size: 14px; font-weight: 600; cursor: pointer;">
                            ‚ú® New Suggestions
                        </button>
                        <button id="refreshCartButton" onclick="refreshCartData()" 
                                style="background: #007AFF; color: white; border: none; border-radius: 8px; padding: 8px 16px; font-size: 14px; font-weight: 600; cursor: pointer;">
                            üîÑ Refresh Cart
                        </button>
                    </div>
                </div>
                <div id="suggestedMeals">
                    <!-- Suggested meals based on preferences will be inserted here -->
                </div>
            </div>

            <!-- Cart Summary -->
            <div id="cartSummary" style="display: flex; align-items: center; gap: 15px; margin-bottom: 20px; padding: 0 20px;">
                <!-- Summary counts will be inserted here -->
            </div>

            <!-- Individual Items -->
            <div class="cart-section" id="individualItemsSection">
                <h3 class="section-header">
                    Individual Items <span id="individualItemsCount" style="color: #666; font-weight: normal; font-size: 16px;"></span>
                </h3>
                <div class="item-grid" id="individualItems">
                    <!-- Individual items will be inserted here -->
                </div>
            </div>

            <!-- Customizable Boxes -->
            <div class="cart-section" id="customizableBoxesSection">
                <h3 class="section-header">
                    Customizable Boxes <span id="customizableBoxesCount" style="color: #666; font-weight: normal; font-size: 16px;"></span>
                </h3>
                <div id="customizableBoxes">
                    <!-- Customizable box data will be inserted here -->
                </div>
            </div>

            <!-- Non-Customizable Boxes -->
            <div class="cart-section" id="nonCustomizableBoxesSection">
                <h3 class="section-header">
                    Fixed Boxes <span id="fixedBoxesCount" style="color: #666; font-weight: normal; font-size: 16px;"></span>
                </h3>
                <div id="nonCustomizableBoxes">
                    <!-- Non-customizable box data will be inserted here -->
                </div>
            </div>

            <!-- Suggested Swaps -->
            <div class="cart-section" id="swapsSection">
                <h3 class="section-header">Suggested Swaps</h3>
                <div id="suggestedSwaps">
                    <!-- Swap suggestions will be inserted here -->
                </div>
            </div>

            <!-- Recommended Add-ons -->
            <div class="cart-section" id="addonsSection">
                <h3 class="section-header" style="display: flex; align-items: center;">
                    <span style="font-size: 20px; margin-right: 8px;">+</span> Premium Add-Ons
                </h3>
                <div id="recommendedAddons">
                    <!-- Add-on recommendations will be inserted here -->
                </div>
            </div>
        </div>
        </div> <!-- End Box Tab -->

        <!-- Plan Tab Content -->
        <div class="tab-content" id="planTab">
            <!-- Meals View - Weekly Meal Calendar -->
            <div class="meals-view section active" id="mealsSection">
            <div class="calendar-header">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 32px;">
                    <div>
                        <h2 style="margin: 0; font-size: 24px; font-weight: 600; color: #1a1a1a;">This Week's Meals</h2>
                        <p style="color: #666; font-size: 15px; margin: 4px 0 0 0;" id="weekDisplay">Plan your Sunday-Thursday dinners</p>
                    </div>
                    <div style="display: flex; gap: 10px;">
                        <!-- Week navigation hidden for now - showing only current delivery week -->
                        <button id="prevWeek" class="nav-button" style="display: none;">‚Äπ</button>
                        <button id="nextWeek" class="nav-button" style="display: none;">‚Ä∫</button>
                        <button id="generatePDF" class="pdf-button" style="display: none;">üìÑ PDF</button>
                    </div>
                </div>
            </div>

            <!-- Loading state -->
            <div id="mealPlanLoading" class="loading-state" style="display: none;">
                <div class="spinner"></div>
                <p>Loading your meal plan...</p>
            </div>

            <!-- Error state -->
            <div id="mealPlanError" class="error-state" style="display: none;">
                <div class="error-icon">‚ö†Ô∏è</div>
                <p>Unable to load meal plan</p>
                <button id="retryLoad" class="retry-button">Try Again</button>
            </div>

            <!-- Simple Meal Card - dedicated container -->
            <div id="simpleMealCardContainer" class="meal-card-container" style="display: block;">
                <div id="simpleMealCard" class="simple-meal-card">
                    <div class="meal-card-header">
                        <h3 id="mealTitle">üçó Suggested Meal</h3>
                        <span id="mealTime">20 mins</span>
                    </div>

                    <div class="meal-ingredients">
                        <h4>Using from your cart:</h4>
                        <div id="simpleMealIngredients" class="ingredients-list">
                            <!-- Ingredients will be populated dynamically -->
                        </div>
                    </div>

                    <div class="meal-actions">
                        <button id="regenerateMeal" class="regenerate-button" onclick="regenerateSimpleMeal()">
                            üîÑ Try Another Recipe
                        </button>
                        <button id="createFullPlan" class="analyze-button" onclick="startAnalysis(); switchTab('cart', document.getElementById('cartTab'));">
                            Create Full Week Plan
                        </button>
                    </div>
                </div>
            </div>

            <!-- Empty state -->
            <div id="mealPlanEmpty" class="empty-state" style="display: none;">
                <div class="empty-content">
                    <h3>No Cart Data</h3>
                    <p>Analyze your cart first to see meal suggestions.</p>
                    <button onclick="switchTab('cart')" class="analyze-button">Analyze Cart</button>
                </div>
            </div>

            <!-- Main Calendar Grid -->
            <div id="mealCalendarGrid" class="calendar-container" style="display: none;">
                <!-- Calendar Days (Vertical Layout) -->
                <div class="calendar-grid">
                    <div class="day-row" data-day="monday">
                        <div class="day-header">
                            <h3>Mon</h3>
                            <span class="day-date" id="monday-date"></span>
                        </div>
                        <div class="meal-slot" data-day="monday">
                            <div class="add-meal-prompt">
                                <span class="add-icon">+</span>
                                <span>Add Meal</span>
                            </div>
                        </div>
                    </div>

                    <div class="day-row" data-day="tuesday">
                        <div class="day-header">
                            <h3>Tue</h3>
                            <span class="day-date" id="tuesday-date"></span>
                        </div>
                        <div class="meal-slot" data-day="tuesday">
                            <div class="add-meal-prompt">
                                <span class="add-icon">+</span>
                                <span>Add Meal</span>
                            </div>
                        </div>
                    </div>

                    <div class="day-row" data-day="wednesday">
                        <div class="day-header">
                            <h3>Wed</h3>
                            <span class="day-date" id="wednesday-date"></span>
                        </div>
                        <div class="meal-slot" data-day="wednesday">
                            <div class="add-meal-prompt">
                                <span class="add-icon">+</span>
                                <span>Add Meal</span>
                            </div>
                        </div>
                    </div>

                    <div class="day-row" data-day="thursday">
                        <div class="day-header">
                            <h3>Thu</h3>
                            <span class="day-date" id="thursday-date"></span>
                        </div>
                        <div class="meal-slot" data-day="thursday">
                            <div class="add-meal-prompt">
                                <span class="add-icon">+</span>
                                <span>Add Meal</span>
                            </div>
                        </div>
                    </div>

                    <div class="day-row" data-day="friday">
                        <div class="day-header">
                            <h3>Fri</h3>
                            <span class="day-date" id="friday-date"></span>
                        </div>
                        <div class="meal-slot" data-day="friday">
                            <div class="add-meal-prompt">
                                <span class="add-icon">+</span>
                                <span>Add Meal</span>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Ingredient Pool Sidebar - Hidden for simplicity -->
                <div class="ingredient-panel" style="display: none;">
                    <h3>Ingredient Pool</h3>
                    <div id="ingredientList" class="ingredient-list">
                        <!-- Ingredients will be loaded here -->
                    </div>
                    <div class="panel-actions">
                        <button id="autoFillWeek" class="auto-fill-button">üéØ Auto-Fill Week</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Settings -->
        <!-- Settings are now handled via modal overlay - no longer need section here -->
    </div>

    <!-- Bottom Tab Navigation -->
    <nav class="bottom-tabs">
        <a href="#cart" class="tab active" onclick="switchTab('cart', this); return false;">
            <svg class="tab-icon icon-cart" viewBox="0 0 24 24">
                <circle cx="8" cy="21" r="1"/>
                <circle cx="19" cy="21" r="1"/>
                <path d="m2.05 2.05h2l2.66 12.42a2 2 0 0 0 2 1.58h9.78a2 2 0 0 0 1.95-1.57l1.65-7.43H5.12"/>
            </svg>
            <span class="tab-label">Cart</span>
        </a>
        <a href="#meals" class="tab" onclick="switchTab('meals', this); return false;">
            <svg class="tab-icon icon-meals" viewBox="0 0 24 24">
                <path d="M8.1 13.34l2.83-2.83L3.91 3.5c-1.56 1.56-1.56 4.09 0 5.66l4.19 4.18zm6.78-1.81c1.53.71 3.68.21 5.27-1.38 1.91-1.91 2.28-4.65.81-6.12-1.46-1.46-4.2-1.1-6.12.81-1.59 1.59-2.09 3.74-1.38 5.27L3.7 19.87l1.41 1.41L12 14.41l6.88 6.88 1.41-1.41L13.41 11.73z"/>
            </svg>
            <span class="tab-label">Meals</span>
        </a>
        <a href="#settings" class="tab" onclick="switchTab('settings', this); return false;">
            <svg class="tab-icon icon-settings" viewBox="0 0 24 24">
                <path d="M12 8c-2.21 0-4 1.79-4 4s1.79 4 4 4 4-1.79 4-4-1.79-4-4-4zm8.94 3c-.46-4.17-3.77-7.48-7.94-7.94V1h-2v2.06C6.83 3.52 3.52 6.83 3.06 11H1v2h2.06c.46 4.17 3.77 7.48 7.94 7.94V23h2v-2.06c4.17-.46 7.48-3.77 7.94-7.94H23v-2h-2.06zM12 19c-3.87 0-7-3.13-7-7s3.13-7 7-7 7 3.13 7 7-3.13 7-7 7z"/>
            </svg>
            <span class="tab-label">Settings</span>
        </a>
    </nav>

    <script>
        let currentState = 'start'; // start, loading, complete
        let mealPlanData = null;
        let refreshesLeft = 3;  // Track refresh count

        // Clear stale cache data to prevent cross-user contamination
        const currentUser = localStorage.getItem('ftpEmail');
        const lastUser = localStorage.getItem('lastLoggedInUser');
        
        if (currentUser && currentUser !== lastUser) {
            // Different user logged in - clear all cached data
            console.log('Different user detected, clearing cache...');
            localStorage.removeItem('cartAnalysisData');
            localStorage.removeItem('cartAnalysisState');
            localStorage.removeItem('cachedMealSuggestions');
            localStorage.removeItem('cachedMealSuggestionsTimestamp');
            localStorage.removeItem('refreshesLeft');
            localStorage.setItem('lastLoggedInUser', currentUser);
        }

        // Check if we have saved credentials
        const userEmail = localStorage.getItem('ftpEmail');
        if (userEmail) {
            document.querySelector('.subtitle').textContent = userEmail;
        }
        
        // Function to load saved cart data from the server
        async function loadSavedCartData() {
            try {
                const response = await fetch('/api/get-saved-cart');
                if (response.ok) {
                    const data = await response.json();
                    if (data && data.cart_data) {
                        // We have saved cart data from the database
                        currentState = 'complete';
                        showCartAnalysis(data.cart_data, data.swaps || [], data.addons || []);
                        return true;
                    }
                }
            } catch (error) {
                console.error('Error loading saved cart:', error);
            }
            
            // Fallback to localStorage if server data not available
            const savedState = localStorage.getItem('cartAnalysisState');
            const savedAnalysis = localStorage.getItem('cartAnalysisData');
            if (savedState === 'complete' && savedAnalysis) {
                try {
                    const { cartData, swaps, addons, timestamp } = JSON.parse(savedAnalysis);
                    // Only restore if data is less than 1 hour old
                    const oneHour = 60 * 60 * 1000;
                    if (Date.now() - timestamp < oneHour) {
                        currentState = 'complete';
                        showCartAnalysis(cartData, swaps, addons);
                        return true;
                    } else {
                        // Clear old data
                        localStorage.removeItem('cartAnalysisData');
                        localStorage.removeItem('cartAnalysisState');
                    }
                } catch (e) {
                    console.error('Error restoring cart analysis:', e);
                }
            }
            return false;
        }
        
        // Load saved cart data on page load
        loadSavedCartData();

        async function startAnalysis() {
            // Clear any previous analysis data
            localStorage.removeItem('cartAnalysisData');
            localStorage.removeItem('cartAnalysisState');
            
            // Switch to loading state
            currentState = 'loading';
            document.getElementById('startSection').classList.remove('active');
            document.getElementById('loadingSection').classList.add('active');
            document.getElementById('headerSubtitle').textContent = 'Analyzing...';

            // Update loading status messages
            const statuses = [
                'Logging into Farm to People...',
                'Found your account! Loading cart...',
                'Analyzing your produce selections...',
                'Creating personalized meal plans...',
                'Almost done...'
            ];

            let statusIndex = 0;
            const statusInterval = setInterval(() => {
                if (statusIndex < statuses.length) {
                    document.getElementById('loadingStatus').textContent = statuses[statusIndex];
                    statusIndex++;
                }
            }, 3000);

            try {
                // Get user phone (from localStorage or prompt)
                let userPhone = localStorage.getItem('userPhone');
                if (!userPhone) {
                    userPhone = prompt('Enter your phone number to analyze your cart:');
                    if (userPhone) {
                        // Ensure we store the full phone number
                        userPhone = userPhone.replace(/\D/g, ''); // Remove non-digits
                        localStorage.setItem('userPhone', userPhone);
                    }
                }
                
                // Fix common phone issues
                if (userPhone) {
                    userPhone = userPhone.replace(/\D/g, ''); // Remove all non-digits
                    // If it's 9 digits and starts with 425 (Seattle area), add the missing digit
                    if (userPhone === '425495323') {
                        userPhone = '4254955323'; // Fix known truncated number
                    }
                }
                
                // Start the actual analysis
                // Pass phone number to use stored credentials from database
                const response = await fetch('/api/analyze-cart', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({
                        phone: userPhone,
                        use_mock: false  // Set to true to use mock data for testing
                    })
                });

                const data = await response.json();
                clearInterval(statusInterval);

                if (data.success) {
                    // CRITICAL: Clear localStorage if fresh data was scraped
                    if (data.fresh_scrape) {
                        console.log('üßπ Fresh scrape detected - clearing localStorage cache');
                        localStorage.removeItem('cartData');
                        localStorage.removeItem('cartTimestamp');
                        localStorage.removeItem('lastCartAnalysis');
                    }

                    showCartAnalysis(data.cart_data, data.swaps, data.addons);
                } else {
                    // Show error message instead of mock data
                    showError(data.error || 'Failed to analyze cart', data.debug_info);
                }
            } catch (error) {
                clearInterval(statusInterval);
                // Show error message instead of mock data
                showError('Network error: ' + error.message);
            }
        }

        function showScrapedTimestamp(cartData) {
            // Show when this cart was scraped
            const timestamp = cartData.scraped_timestamp;
            if (timestamp) {
                const date = new Date(timestamp);
                const formatted = date.toLocaleString('en-US', {
                    month: 'short',
                    day: 'numeric',
                    hour: 'numeric',
                    minute: '2-digit',
                    hour12: true
                });
                
                // Add timestamp display near delivery date
                const deliveryElem = document.getElementById('deliveryDate');
                if (deliveryElem) {
                    const timestampDiv = document.createElement('div');
                    timestampDiv.style.fontSize = '11px';
                    timestampDiv.style.color = '#888';
                    timestampDiv.style.marginTop = '2px';
                    timestampDiv.innerHTML = `<i>Cart updated: ${formatted}</i>`;
                    
                    // Add after delivery date text
                    const textElem = document.getElementById('deliveryDateText');
                    if (textElem && textElem.parentNode) {
                        textElem.parentNode.appendChild(timestampDiv);
                    }
                }
            }
        }
        
        function showError(message, debugInfo) {
            currentState = 'error';
            document.getElementById('loadingSection').classList.remove('active');
            document.getElementById('cartAnalysisSection').classList.add('active');
            document.getElementById('headerSubtitle').textContent = 'Error analyzing cart';
            
            // Show error in the cart analysis section
            document.getElementById('cartAnalysisSection').innerHTML = `
                <div style="background: #fee; border: 2px solid #fcc; border-radius: 12px; padding: 20px; margin: 20px;">
                    <h3 style="color: #d00; margin-bottom: 10px;">‚ö†Ô∏è Cart Analysis Error</h3>
                    <p style="color: #800; margin-bottom: 10px;">${message}</p>
                    ${debugInfo ? `<details style="margin-top: 10px;">
                        <summary style="cursor: pointer; color: #666;">Debug Info (click to expand)</summary>
                        <pre style="background: #f5f5f5; padding: 10px; margin-top: 10px; font-size: 12px; overflow-x: auto;">${typeof debugInfo === 'string' ? debugInfo : JSON.stringify(debugInfo, null, 2)}</pre>
                    </details>` : ''}
                    <button onclick="startAnalysis()" style="background: #28a745; color: white; border: none; padding: 12px 24px; border-radius: 8px; margin-top: 15px; cursor: pointer;">Try Again</button>
                </div>
            `;
        }
        
        // DEPRECATED: Mock data function - no longer used
        function showMockCartAnalysis() {
            // Show error instead of mock data
            showError('Mock data disabled. Please fix the real cart analysis.', 'Mock data was being shown because the real cart analysis failed.');
            return;
            
            // Original mock data code (disabled)
            const realCartData = {
                individual_items: [
                    {name: "Pasture Raised Eggs", quantity: 1, unit: "1 dozen", price: "$7.49", type: "individual"},
                    {name: "Organic & Fair Trade Hass Avocados", quantity: 5, unit: "1 piece", price: "$12.50", type: "individual"},
                    {name: "Organic & Fair Trade Bananas (Ripe)", quantity: 1, unit: "1 bunch", price: "$2.49", type: "individual"}
                ],
                customizable_boxes: [
                    {
                        box_name: "The Cook's Box - Paleo",
                        selected_items: [
                            {name: "Boneless, Skinless Chicken Breast", unit: ".7-1lb", producer: "Locust Point Farm"},
                            {name: "Black Sea Bass", unit: "8.0 oz", producer: "Red's Best Seafood"},
                            {name: "Local Yellow Peaches", unit: "2 pieces", producer: "Lancaster Farm Fresh Cooperative"},
                            {name: "Organic Leaf Lettuce", unit: "1 head", producer: "Sun Sprout Farm"},
                            {name: "Mixed Cherry Tomatoes", unit: "1 pint", producer: "Eagle Road Farm"},
                            {name: "Lunchbox Peppers", unit: "12.0 oz", producer: "Sunny Harvest"},
                            {name: "Organic Italian Eggplant", unit: "1 piece", producer: "Lancaster Farm Fresh Cooperative"},
                            {name: "Unagi Cucumbers", unit: "2 pieces", producer: "Sunny Harvest"},
                            {name: "Organic Green Zucchini", unit: "2 pieces", producer: "Sun Sprout Farm"}
                        ],
                        available_alternatives: [
                            {name: "White Ground Turkey", unit: "1.0 Lbs", producer: "Koch's Turkey Farm"},
                            {name: "Pork Kielbasa", unit: "1 Lbs", producer: "Autumn's Harvest"},
                            {name: "Yellow Nectarines", unit: "2 pieces", producer: "Weaver's Orchard"},
                            {name: "Red Onions", unit: "2 Lbs", producer: "Dagele Brothers Produce"},
                            {name: "Yellow Onions", unit: "2.0 Lbs", producer: "Dagele Brothers Produce"}
                        ],
                        selected_count: 9,
                        alternatives_count: 10
                    }
                ],
                non_customizable_boxes: [
                    {
                        box_name: "Seasonal Fruit Medley",
                        selected_items: [
                            {name: "Prune Plums", unit: "1 Lbs"},
                            {name: "Honeycrisp Apples", unit: "2 pieces"},
                            {name: "Local Yellow Peaches", unit: "2 pieces"}
                        ],
                        selected_count: 3,
                        customizable: false
                    }
                ]
            };
            showCartAnalysis(realCartData);
        }

        // Helper function to clean duplicate producer names
        function cleanProducerName(producer) {
            if (!producer) return '';
            // Handle duplicated names like "Lagoner FarmsLagoner Farms"
            // Check if the name is duplicated by seeing if first half equals second half
            const halfLength = Math.floor(producer.length / 2);
            const firstHalf = producer.substring(0, halfLength);
            const secondHalf = producer.substring(halfLength);
            
            if (firstHalf === secondHalf) {
                return firstHalf;
            }
            
            // Also handle cases with slight variations
            // Try to detect if a farm name appears twice
            const commonFarmWords = ['Farm', 'Farms', 'Acres', 'Growers', 'Harvest', 'Cooperative'];
            for (const word of commonFarmWords) {
                const pattern = new RegExp(`(.+${word})\\1`, 'i');
                const match = producer.match(pattern);
                if (match) {
                    return match[1];
                }
            }
            
            return producer;
        }
        
        // Helper function to determine item category
        function getItemCategory(itemName) {
            const name = itemName.toLowerCase();
            
            // Protein items
            if (name.includes('chicken') || name.includes('beef') || name.includes('turkey') || 
                name.includes('pork') || name.includes('sausage') || name.includes('fish') || 
                name.includes('salmon') || name.includes('bass') || name.includes('egg') ||
                name.includes('kielbasa') || name.includes('steelhead') || name.includes('filet') ||
                name.includes('cod') || name.includes('tuna') || name.includes('shrimp')) {
                return 'protein';
            }
            
            // Dairy items
            if (name.includes('cheese') || name.includes('milk') || name.includes('yogurt') || 
                name.includes('butter') || name.includes('mozzarella') || name.includes('cheddar') ||
                name.includes('feta')) {
                return 'dairy';
            }
            
            // Fruit items - be very specific about what is actually a fruit
            // Only include items that are typically snackable fruits
            if (name.includes('apple') || name.includes('banana') || name.includes('peach') || 
                name.includes('plum') || name.includes('nectarine') || name.includes('berry') ||
                name.includes('melon') || name.includes('pear') || name.includes('grape') ||
                name.includes('grapefruit') || name.includes('mango')) {
                return 'fruit';
            }
            
            // Check for oranges specifically (but not orange-colored vegetables)
            if (name.includes('orange') && !name.includes('carrot') && !name.includes('pepper') && 
                !name.includes('bell') && !name.includes('squash')) {
                return 'fruit';
            }
            
            // Default to produce (vegetables, herbs, etc)
            // This includes tomatoes, peppers, lettuce, kale, zucchini, carrots, etc.
            return 'produce';
        }
        
        // Helper function to show delivery date in header
        function showDeliveryDate(cartData) {
            const deliveryInfo = cartData?.delivery_info;
            if (deliveryInfo && deliveryInfo.delivery_text) {
                // Parse "Shopping for: Sun, Aug 31, 10:00AM - 4:00PM"
                const text = deliveryInfo.delivery_text;
                const match = text.match(/Shopping for: (.+?),.*(\d{1,2}:\d{2}[AP]M)/);
                
                if (match) {
                    const dayDate = match[1].trim(); // "Sun, Aug 31"
                    const time = match[2]; // "10:00AM"
                    
                    // Format for display
                    const displayText = `${dayDate} ‚Ä¢ ${time}`;
                    
                    document.getElementById('deliveryDateText').textContent = displayText;
                    document.getElementById('deliveryDate').style.display = 'block';
                    
                    // Calculate and show cart cutoff time
                    showCartCutoffTime(dayDate);
                } else {
                    // Fallback - show raw text
                    document.getElementById('deliveryDateText').textContent = text.replace('Shopping for: ', '');
                    document.getElementById('deliveryDate').style.display = 'block';
                }
            }
        }
        
        function showCartCutoffTime(deliveryDateStr) {
            console.log('üïí Calculating cart cutoff time for delivery:', deliveryDateStr);

            // Parse the delivery date (e.g., "Mon, Sep 15")
            const days = ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'];
            const dayMatch = deliveryDateStr.match(/^(\w{3})/);

            if (dayMatch) {
                const deliveryDay = dayMatch[1];
                const deliveryDayIndex = days.indexOf(deliveryDay);

                console.log('üïí Delivery day details:', {
                    deliveryDay: deliveryDay,
                    deliveryDayIndex: deliveryDayIndex
                });

                if (deliveryDayIndex !== -1) {
                    // Calculate cutoff day (day before delivery)
                    const cutoffDayIndex = deliveryDayIndex === 0 ? 6 : deliveryDayIndex - 1;
                    const cutoffDay = days[cutoffDayIndex];

                    // Create cutoff time display matching delivery date format
                    const cutoffText = `${cutoffDay} ‚Ä¢ 11:59AM`;

                    console.log('üïí Calculated cutoff:', cutoffText);
                    
                    // Add cutoff time to the header
                    const headerSubtitle = document.getElementById('headerSubtitle');
                    if (headerSubtitle && headerSubtitle.textContent === 'Cart analysis complete') {
                        // Remove any existing cutoff warning first
                        const existingCutoff = document.getElementById('cartCutoffWarning');
                        if (existingCutoff) {
                            existingCutoff.remove();
                        }

                        // Add cutoff time warning
                        const cutoffDiv = document.createElement('div');
                        cutoffDiv.id = 'cartCutoffWarning';
                        cutoffDiv.style.cssText = 'color: #FF6B35; font-size: 12px; margin-top: 4px; font-weight: 500;';
                        cutoffDiv.innerHTML = `‚è∞ Cart locks: ${cutoffText}`;

                        // Insert after the subtitle
                        const headerElement = headerSubtitle.parentElement;
                        if (headerElement) {
                            headerElement.appendChild(cutoffDiv);
                        }
                    }
                }
            }
        }
        
        // Helper function to get category colors (minimal style like the reference image)
        function getCategoryColors(category) {
            const colors = {
                'protein': { bg: '#FFF0F0', text: '#D32F2F', border: '#FFCDD2' },
                'produce': { bg: '#F1F8F4', text: '#2E7D32', border: '#C8E6C9' },
                'dairy': { bg: '#E3F2FD', text: '#1976D2', border: '#BBDEFB' },
                'fruit': { bg: '#FFF8E1', text: '#F57C00', border: '#FFE082' },  // Changed to orange like pantry
                'pantry': { bg: '#FFF8E1', text: '#F57C00', border: '#FFE082' }
            };
            return colors[category] || colors['produce'];
        }
        
        function showCartAnalysis(cartData, swaps = [], addons = []) {
            currentState = 'complete';
            
            // Set global mealPlanData so meal calendar can access cart data
            mealPlanData = { cart_data: cartData };
            
            // Store cart analysis data in localStorage for persistence
            const analysisData = { cartData, swaps, addons, timestamp: Date.now() };
            localStorage.setItem('cartAnalysisData', JSON.stringify(analysisData));
            localStorage.setItem('cartAnalysisState', 'complete');
            document.getElementById('loadingSection').classList.remove('active');
            document.getElementById('cartAnalysisSection').classList.add('active');
            document.getElementById('headerSubtitle').textContent = 'Cart analysis complete';
            
            // Show delivery date and timestamp if available
            showDeliveryDate(cartData);
            showScrapedTimestamp(cartData);

            // Always generate fresh meal suggestions - no caching for now
            console.log('üçΩÔ∏è Generating fresh meal suggestions from current cart');
            generateMealSuggestionsFromAPI(cartData);

            // Sync meals from Cart tab to Meals tab
            setTimeout(() => {
                syncMealsFromCart();
            }, 500);
            
            // Calculate and display category counts
            const categoryCounts = { protein: 0, produce: 0, fruit: 0 };
            
            // Count from individual items
            if (cartData.individual_items) {
                cartData.individual_items.forEach(item => {
                    const category = getItemCategory(item.name);
                    if (category === 'protein' || category === 'produce' || category === 'fruit') {
                        categoryCounts[category] += item.quantity || 1;
                    }
                });
            }
            
            // Count from customizable boxes
            if (cartData.customizable_boxes) {
                cartData.customizable_boxes.forEach(box => {
                    if (box.selected_items) {
                        box.selected_items.forEach(item => {
                            const category = getItemCategory(item.name);
                            if (category === 'protein' || category === 'produce' || category === 'fruit') {
                                categoryCounts[category] += item.quantity || 1;
                            }
                        });
                    }
                });
            }
            
            // Count from non_customizable_boxes (but some might actually be customizable!)
            if (cartData.non_customizable_boxes) {
                cartData.non_customizable_boxes.forEach(box => {
                    if (box.selected_items) {
                        box.selected_items.forEach(item => {
                            const category = getItemCategory(item.name);
                            if (category === 'protein' || category === 'produce' || category === 'fruit') {
                                categoryCounts[category] += item.quantity || 1;
                            }
                        });
                    }
                });
            }
            
            // Display summary with category counts - all in one row
            const summaryItems = [];
            
            if (categoryCounts.protein > 0) {
                summaryItems.push(`
                    <span style="font-size: 18px; color: #333; font-weight: 500;">${categoryCounts.protein}√ó protein</span>
                `);
            }
            
            // Remove produce from summary - user only wants protein and fruit counts
            
            if (categoryCounts.fruit > 0) {
                summaryItems.push(`
                    <span style="font-size: 18px; color: #333; font-weight: 500;">${categoryCounts.fruit}√ó fruit</span>
                `);
            }
            
            
            // Remove add-ons from summary for cleaner look
            
            document.getElementById('cartSummary').innerHTML = summaryItems.join('');

            // Show individual items with category tags
            if (cartData.individual_items && cartData.individual_items.length > 0) {
                // Update count
                document.getElementById('individualItemsCount').textContent = `(${cartData.individual_items.length} items)`;
                
                const individualHTML = cartData.individual_items.map(item => {
                    // Get category and colors
                    const category = getItemCategory(item.name);
                    const colors = getCategoryColors(category);
                    
                    // Format quantity properly
                    let quantityText = '';
                    if (item.unit.startsWith('1 ')) {
                        // Unit already contains "1 dozen", "1 piece", etc.
                        // Replace the "1" with actual quantity if different
                        if (item.quantity === 1) {
                            quantityText = item.unit;
                        } else {
                            // Replace "1 piece" with "5 pieces", "1 dozen" stays as is for quantity 1
                            const unitPart = item.unit.substring(2); // Remove "1 " prefix
                            // Pluralize if needed
                            if (item.quantity > 1 && unitPart === 'piece') {
                                quantityText = `${item.quantity} pieces`;
                            } else if (item.quantity > 1 && unitPart === 'bunch') {
                                quantityText = `${item.quantity} bunches`;
                            } else if (item.quantity > 1 && unitPart === 'head') {
                                quantityText = `${item.quantity} heads`;
                            } else {
                                quantityText = `${item.quantity} ${unitPart}`;
                            }
                        }
                    } else {
                        // Unit doesn't start with "1 ", use as is
                        quantityText = item.quantity > 1 ? `${item.quantity} √ó ${item.unit}` : item.unit;
                    }
                    
                    return `
                        <div class="cart-item" style="display: flex; align-items: center; padding: 12px; border-bottom: 1px solid #eee;">
                            <div class="item-details" style="flex: 1;">
                                <div class="item-name" style="font-size: 15px; font-weight: 600; color: #4169E1; margin-bottom: 2px;">${item.name}</div>
                                <div class="item-meta" style="color: #666; font-size: 13px;">${quantityText}${item.producer ? ` ‚Ä¢ ${cleanProducerName(item.producer)}` : ''}</div>
                            </div>
                            <div style="display: flex; align-items: center; gap: 10px;">
                                <div class="item-price" style="color: #2e7d32; font-weight: 600; font-size: 15px; min-width: 55px; text-align: right;">${item.price || ''}</div>
                                <span class="category-tag" style="
                                    background: rgba(255, 255, 255, 0.7);
                                    color: ${colors.text};
                                    padding: 3px 9px;
                                    border-radius: 10px;
                                    font-size: 12px;
                                    font-weight: 500;
                                    text-align: center;
                                    border: 1px solid rgba(0, 0, 0, 0.1);
                                    display: inline-block;
                                    opacity: 0.9;
                                ">${category}</span>
                            </div>
                        </div>
                    `;
                }).join('');
                document.getElementById('individualItems').innerHTML = individualHTML;
            } else {
                document.getElementById('individualItemsSection').style.display = 'none';
            }

            // Separate boxes based on customizable flag (not which array they're in)
            const allBoxes = [...(cartData.customizable_boxes || []), ...(cartData.non_customizable_boxes || [])];

            console.log('üîç Debug cart box data:', {
                customizable_boxes: cartData.customizable_boxes,
                non_customizable_boxes: cartData.non_customizable_boxes,
                allBoxes: allBoxes
            });

            const actuallyCustomizable = allBoxes.filter(box => box.customizable === true || box.customizable === undefined && box.alternatives_count > 0);
            const actuallyNonCustomizable = allBoxes.filter(box => box.customizable === false);

            console.log('üîç Box filtering results:', {
                actuallyCustomizable: actuallyCustomizable,
                actuallyNonCustomizable: actuallyNonCustomizable
            });
            
            // Show customizable boxes with category tags
            if (actuallyCustomizable.length > 0) {
                // Update count
                let totalItems = 0;
                actuallyCustomizable.forEach(box => {
                    totalItems += (box.selected_items ? box.selected_items.length : 0);
                });
                document.getElementById('customizableBoxesCount').textContent = `(${totalItems} items)`;
                
                const customizableHTML = actuallyCustomizable.map(box => `
                    <div style="margin-bottom: 20px;">
                        <div class="box-header">
                            <div style="display: flex; align-items: center; gap: 10px;">
                                <div class="box-name">${box.box_name}</div>
                                ${box.price ? `<span style="color: #2e7d32; font-weight: normal; font-size: 16px;">${box.price}</span>` : ''}
                            </div>
                            <div class="box-status">${box.alternatives_count} available alternatives</div>
                        </div>
                        <div class="item-grid">
                            ${box.selected_items.map(item => {
                                const category = getItemCategory(item.name);
                                const colors = getCategoryColors(category);
                                return `
                                    <div class="cart-item" style="display: flex; align-items: center; padding: 12px; border-bottom: 1px solid #eee;">
                                        <div class="item-details" style="flex: 1;">
                                            <div class="item-name">${item.name}</div>
                                            <div class="item-meta" style="color: #666; font-size: 14px;">${item.unit}${item.producer ? ` ‚Ä¢ ${cleanProducerName(item.producer)}` : ''}</div>
                                        </div>
                                        <span class="category-tag" style="
                                            background: rgba(255, 255, 255, 0.7);
                                            color: ${colors.text};
                                            padding: 3px 9px;
                                            border-radius: 10px;
                                            font-size: 12px;
                                            font-weight: 500;
                                            text-align: center;
                                            border: 1px solid rgba(0, 0, 0, 0.1);
                                            display: inline-block;
                                            opacity: 0.9;
                                        ">${category}</span>
                                    </div>
                                `;
                            }).join('')}
                        </div>
                    </div>
                `).join('');
                document.getElementById('customizableBoxes').innerHTML = customizableHTML;
            } else {
                document.getElementById('customizableBoxesSection').style.display = 'none';
            }

            // Show non-customizable boxes with category tags
            if (actuallyNonCustomizable.length > 0) {
                // Update count
                let totalItems = 0;
                actuallyNonCustomizable.forEach(box => {
                    totalItems += (box.selected_items ? box.selected_items.length : 0);
                });
                document.getElementById('fixedBoxesCount').textContent = `(${totalItems} items)`;
                
                const nonCustomizableHTML = actuallyNonCustomizable.map(box => `
                    <div style="margin-bottom: 20px;">
                        <div class="box-header">
                            <div style="display: flex; align-items: center; gap: 10px;">
                                <div class="box-name">${box.box_name}</div>
                                ${box.price ? `<span style="color: #2e7d32; font-weight: normal; font-size: 16px;">${box.price}</span>` : ''}
                            </div>
                            <div class="box-status">Fixed selection</div>
                        </div>
                        <div class="item-grid">
                            ${box.selected_items.map(item => {
                                const category = getItemCategory(item.name);
                                const colors = getCategoryColors(category);
                                return `
                                    <div class="cart-item" style="display: flex; align-items: center; padding: 12px; border-bottom: 1px solid #eee;">
                                        <div class="item-details" style="flex: 1;">
                                            <div class="item-name">${item.name}</div>
                                            <div class="item-meta" style="color: #666; font-size: 14px;">${item.unit}</div>
                                        </div>
                                        <span class="category-tag" style="
                                            background: rgba(255, 255, 255, 0.7);
                                            color: ${colors.text};
                                            padding: 3px 9px;
                                            border-radius: 10px;
                                            font-size: 12px;
                                            font-weight: 500;
                                            text-align: center;
                                            border: 1px solid rgba(0, 0, 0, 0.1);
                                            display: inline-block;
                                            opacity: 0.9;
                                        ">${category}</span>
                                    </div>
                                `;
                            }).join('')}
                        </div>
                    </div>
                `).join('');
                document.getElementById('nonCustomizableBoxes').innerHTML = nonCustomizableHTML;
            } else {
                document.getElementById('nonCustomizableBoxesSection').style.display = 'none';
            }

            // Show AI-generated swaps (2025-08-29: Using GPT-5 generated swaps)
            if (swaps && swaps.length > 0) {
                const swapsHTML = swaps.map(swap => `
                    <div class="swap-suggestion">
                        <div class="swap-text">Swap ${swap.from} ‚Üí ${swap.to}</div>
                        <div class="swap-reason" style="font-size: 12px; color: #666; margin-top: 4px;">${swap.reason}</div>
                    </div>
                `).join('');
                document.getElementById('suggestedSwaps').innerHTML = swapsHTML;
            } else {
                document.getElementById('suggestedSwaps').innerHTML = '<div style="color: #666; padding: 10px;">No swaps needed - your selections look great!</div>';
            }

            // Show AI-generated fresh add-ons (2025-08-29: Fresh ingredients only, no pantry staples)
            if (addons && addons.length > 0) {
                const addonsHTML = addons.map(addon => {
                    // Determine category and color using the same helper function
                    const category = addon.category || 'produce';
                    const colors = getCategoryColors(category);
                    
                    return `
                        <div class="addon-item" style="display: flex; align-items: center; padding: 12px; border-bottom: 1px solid #eee;">
                            <div class="item-details" style="flex: 1;">
                                <div style="display: flex; align-items: center; gap: 10px;">
                                    <div class="item-name" style="font-weight: 600;">${addon.item}</div>
                                    <div class="item-price" style="color: #2e7d32; font-weight: 600;">${addon.price || '$3.99'}</div>
                                </div>
                                <div class="item-meta" style="color: #666; font-size: 14px; margin-top: 2px;">${addon.reason}</div>
                            </div>
                            <span class="category-tag" style="
                                background: rgba(255, 255, 255, 0.7);
                                color: ${colors.text};
                                padding: 3px 9px;
                                border-radius: 10px;
                                font-size: 12px;
                                font-weight: 500;
                                text-align: center;
                                border: 1px solid rgba(0, 0, 0, 0.1);
                                display: inline-block;
                                opacity: 0.9;
                            ">${category}</span>
                        </div>
                    `;
                }).join('');
                document.getElementById('recommendedAddons').innerHTML = addonsHTML;
            } else {
                // No addons suggested
                document.getElementById('recommendedAddons').innerHTML = '<div style="color: #666; padding: 10px;">Your cart is complete!</div>';
            }
        }

        function generateMealSuggestions(cartData) {
            // Analyze cart contents to suggest meals
            const proteins = [];
            const vegetables = [];
            
            // Extract proteins and vegetables from cart
            cartData.customizable_boxes?.forEach(box => {
                box.selected_items.forEach(item => {
                    if (item.name.includes('Chicken') || item.name.includes('Bass') || item.name.includes('Turkey')) {
                        proteins.push(item.name);
                    }
                    if (item.name.includes('Lettuce') || item.name.includes('Tomatoes') || 
                        item.name.includes('Peppers') || item.name.includes('Zucchini') || 
                        item.name.includes('Eggplant') || item.name.includes('Cucumbers')) {
                        vegetables.push(item.name);
                    }
                });
            });

            // Generate meal suggestions prioritizing dinner, then other meals
            const mealSuggestions = [
                {
                    name: "Pan-Seared Chicken + Cherry Tomato Salad",
                    time: 20,
                    protein: 35,
                    type: "Dinner",
                    servings: 2,
                    priority: 1
                },
                {
                    name: "Black Sea Bass + Grilled Vegetables",
                    time: 25,
                    protein: 28,
                    type: "Dinner", 
                    servings: 2,
                    priority: 1
                },
                {
                    name: "Stuffed Eggplant + Zucchini",
                    time: 35,
                    protein: 12,
                    type: "Lunch",
                    servings: 4,
                    priority: 2
                },
                {
                    name: "Avocado + Egg Breakfast Bowl",
                    time: 10,
                    protein: 18,
                    type: "Breakfast",
                    servings: 1,
                    priority: 3
                },
                {
                    name: "Cucumber + Pepper Fresh Salad",
                    time: 5,
                    protein: 6,
                    type: "Side",
                    servings: 2,
                    priority: 4
                }
            ];

            // Sort by priority (dinner first) and return top 4
            return mealSuggestions.sort((a, b) => a.priority - b.priority).slice(0, 4);
        }

        // Refresh meals button handler
        document.addEventListener('DOMContentLoaded', () => {
            const refreshButton = document.getElementById('refreshMeals');
            if (refreshButton) {
                refreshButton.addEventListener('click', async () => {
                    if (refreshesLeft > 0) {
                        // Disable button during refresh
                        refreshButton.disabled = true;
                        refreshButton.innerHTML = '‚è≥ Generating new meals...';
                        
                        try {
                            // Call API to regenerate meals
                            const response = await fetch('/api/refresh-meals', {
                                method: 'POST',
                                headers: {'Content-Type': 'application/json'},
                                body: JSON.stringify({
                                    cart_data: mealPlanData,
                                    phone: localStorage.getItem('userPhone')
                                })
                            });
                            
                            const data = await response.json();
                            
                            if (data.success) {
                                // Update meal suggestions and cache them
                                localStorage.setItem('cachedMealSuggestions', JSON.stringify(data.meals));
                                localStorage.setItem('cachedMealSuggestionsTimestamp', Date.now().toString());
                                updateMealSuggestions(data.meals);
                                
                                // Decrement refresh count
                                refreshesLeft--;
                                localStorage.setItem('refreshesLeft', refreshesLeft);
                                
                                // Update button
                                if (refreshesLeft > 0) {
                                    refreshButton.disabled = false;
                                    refreshButton.innerHTML = `üîÑ Try Different Meals (${refreshesLeft} left)`;
                                } else {
                                    refreshButton.disabled = true;
                                    refreshButton.innerHTML = 'üîÑ No refreshes left';
                                    refreshButton.style.background = '#dee2e6';
                                }
                            } else {
                                // Re-enable on error
                                refreshButton.disabled = false;
                                refreshButton.innerHTML = `üîÑ Try Different Meals (${refreshesLeft} left)`;
                                alert('Failed to generate new meals. Please try again.');
                            }
                        } catch (error) {
                            console.error('Error refreshing meals:', error);
                            refreshButton.disabled = false;
                            refreshButton.innerHTML = `üîÑ Try Different Meals (${refreshesLeft} left)`;
                        }
                    }
                });
            }
            
            // Load refresh count from localStorage
            const savedRefreshes = localStorage.getItem('refreshesLeft');
            if (savedRefreshes !== null) {
                refreshesLeft = parseInt(savedRefreshes);
                const refreshSpan = document.getElementById('refreshCount');
                if (refreshSpan) {
                    refreshSpan.textContent = refreshesLeft;
                }
            }
        });

        function updateMealSuggestions(meals) {
            // Update the meal suggestions container with new meals
            const container = document.getElementById('mealSuggestionsContainer');
            if (container && meals) {
                // Clear existing meals
                container.innerHTML = '';
                
                // Add new meals with enhanced information
                meals.forEach((meal, index) => {
                    const mealCard = document.createElement('div');
                    mealCard.className = 'meal-card';
                    
                    // Build ingredients list if available
                    const ingredientsText = meal.ingredients_used && meal.ingredients_used.length > 0 
                        ? `<div class="meal-ingredients">Uses: ${meal.ingredients_used.slice(0,3).join(', ')}</div>` 
                        : '';
                    
                    // Add note if present
                    const noteText = meal.note ? `<div class="meal-note">üí° ${meal.note}</div>` : '';
                    
                    // Show how many dinners this makes
                    const servingsText = meal.makes_x_dinners || `Serves ${meal.servings || 2}`;
                    
                    mealCard.innerHTML = `
                        <div class="meal-header">
                            <span class="meal-name">${meal.name}</span>
                            <span class="meal-meta">${meal.time} ‚Ä¢ ${meal.protein}g protein ‚Ä¢ ${meal.type || 'Dinner'}</span>
                        </div>
                        <div class="meal-servings">${servingsText}</div>
                        ${ingredientsText}
                        ${noteText}
                    `;
                    container.appendChild(mealCard);
                });
            }
        }

        async function generateMealSuggestionsFromAPI(cartData) {
            try {
                console.log('üçΩÔ∏è Calling GPT-5 API for meal suggestions...');
                
                // Show loading state
                document.getElementById('suggestedMeals').innerHTML = `
                    <div style="text-align: center; padding: 20px; color: #666;">
                        ü§ñ GPT-5 is creating personalized meal suggestions...
                    </div>
                `;
                
                const response = await fetch('/api/refresh-meals', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({
                        cart_data: cartData,
                        phone: localStorage.getItem('userPhone')
                    })
                });
                
                const data = await response.json();
                
                if (data.success && data.meals && data.meals.length > 0) {
                    console.log('‚úÖ Got meal suggestions from GPT-5:', data.meals);
                    updateMealSuggestions(data.meals);
                } else {
                    console.error('‚ùå Meal generation failed:', data.error || 'Unknown error');
                    
                    // Show clear error message
                    document.getElementById('suggestedMeals').innerHTML = `
                        <div style="background: #fee; border: 1px solid #fcc; border-radius: 8px; padding: 16px; margin: 8px 0;">
                            <div style="color: #d00; font-weight: 600; margin-bottom: 8px;">
                                ‚ö†Ô∏è Meal Generation Error
                            </div>
                            <div style="color: #800; font-size: 14px;">
                                ${data.error || 'Unable to generate meal suggestions'}
                            </div>
                            ${data.debug_info ? `
                                <div style="margin-top: 12px; padding-top: 12px; border-top: 1px solid #fcc;">
                                    <div style="font-size: 12px; color: #666;">Debug Info:</div>
                                    <div style="font-size: 12px; color: #666; margin-top: 4px;">
                                        Proteins: ${data.debug_info.proteins_found?.length || 0} items<br>
                                        Vegetables: ${data.debug_info.vegetables_found?.length || 0} items<br>
                                        Error: ${data.debug_info.error_message || 'Unknown'}
                                    </div>
                                </div>
                            ` : ''}
                        </div>
                    `;
                    
                    if (data.debug_info) {
                        console.log('Debug information:', data.debug_info);
                    }
                }
            } catch (error) {
                console.error('Error generating meal suggestions:', error);
                // Show error state
                document.getElementById('suggestedMeals').innerHTML = `
                    <div style="text-align: center; padding: 20px; color: #666;">
                        Error generating meal suggestions. Please try refreshing.
                    </div>
                `;
            }
        }

        async function regenerateSwapsAndAddons(cartData) {
            try {
                console.log('üîÑ Generating new swaps and add-ons...');
                
                // For now, just call analyze-cart with regenerate flag
                // This will regenerate swaps and addons from the same cart
                const response = await fetch('/api/analyze-cart', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({
                        phone: localStorage.getItem('userPhone'),
                        use_mock: false,
                        regenerate_only: true  // Signal to skip scraping, just regenerate suggestions
                    })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    // CRITICAL: Clear localStorage if fresh data was scraped
                    if (data.fresh_scrape) {
                        console.log('üßπ Fresh scrape detected in refresh - clearing localStorage cache');
                        localStorage.removeItem('cartData');
                        localStorage.removeItem('cartTimestamp');
                        localStorage.removeItem('lastCartAnalysis');
                    }

                    // Update swaps display
                    if (data.swaps && data.swaps.length > 0) {
                        updateSwapSuggestions(data.swaps);
                    }
                    
                    // Update add-ons display
                    if (data.addons && data.addons.length > 0) {
                        updatePremiumAddons(data.addons);
                    }
                    
                    // Update stored data
                    const storedData = JSON.parse(localStorage.getItem('cartAnalysisData'));
                    storedData.swaps = data.swaps || [];
                    storedData.addons = data.addons || [];
                    localStorage.setItem('cartAnalysisData', JSON.stringify(storedData));
                }
            } catch (error) {
                console.error('Error generating swaps/addons:', error);
                // Don't alert here, let the main function handle errors
            }
        }
        
        async function refreshSuggestions() {
            // Just regenerate meal suggestions without re-scraping cart
            const button = document.getElementById('refreshSuggestionsButton');
            const originalText = button.innerHTML;
            
            try {
                button.disabled = true;
                button.innerHTML = '‚è≥ Generating...';
                
                // Get the stored cart data
                const storedData = localStorage.getItem('cartAnalysisData');
                if (!storedData) {
                    alert('Please analyze your cart first');
                    return;
                }
                
                const { cartData } = JSON.parse(storedData);
                
                // Generate new meal suggestions from existing cart
                console.log('üé≤ Generating new meal suggestions from current cart');
                await generateMealSuggestionsFromAPI(cartData);
                
                // Also regenerate swaps and add-ons
                await regenerateSwapsAndAddons(cartData);
                
            } catch (error) {
                console.error('Error refreshing suggestions:', error);
                alert('Failed to generate new suggestions. Please try again.');
            } finally {
                button.disabled = false;
                button.innerHTML = originalText;
            }
        }
        
        async function refreshCartData() {
            // Clear stored data to force fresh analysis
            localStorage.removeItem('cartAnalysisData');
            localStorage.removeItem('cartAnalysisState');
            
            const button = document.getElementById('refreshCartButton');
            const originalText = button.innerHTML;
            
            try {
                button.disabled = true;
                button.innerHTML = '‚è≥ Scraping FTP...';
                
                // Re-run full cart analysis (including scraping)
                await startAnalysis();
                
            } catch (error) {
                console.error('Error refreshing cart:', error);
                alert('Failed to refresh cart data. Please try again.');
            } finally {
                button.disabled = false;
                button.innerHTML = originalText;
            }
        }
        
        // ===== SETTINGS FUNCTIONALITY =====
        
        async function loadUserSettings() {
            try {
                const userPhone = getPhoneNumber();
                const response = await fetch(`/api/settings/${userPhone}`);
                
                if (response.ok) {
                    const userData = await response.json();
                    displayUserSettings(userData);
                } else {
                    // Show fallback data from localStorage
                    displayFallbackSettings();
                }
            } catch (error) {
                console.error('Error loading user settings:', error);
                displayFallbackSettings();
            }
        }
        
        function displayUserSettings(userData) {
            const preferences = userData.preferences || {};
            
            // Account Information
            document.getElementById('userEmailDisplay').textContent = 
                localStorage.getItem('ftpEmail') || 'Not connected';
            document.getElementById('userPhoneDisplay').textContent = 
                formatPhoneNumber(getPhoneNumber()) || 'Not provided';
            
            // Household Information
            document.getElementById('householdSizeDisplay').textContent = 
                preferences.household_size || 'Not specified';
            document.getElementById('mealTimingDisplay').textContent = 
                preferences.meal_timing ? preferences.meal_timing.join(', ') : 'Not specified';
            
            // Meal Preferences
            document.getElementById('favoriteMealsDisplay').textContent = 
                preferences.selected_meals ? `${preferences.selected_meals.length} dishes selected` : 'None selected';
            document.getElementById('cookingMethodsDisplay').textContent = 
                preferences.cooking_methods ? preferences.cooking_methods.join(', ') : 'All methods';
            
            // Dietary Requirements
            const restrictions = preferences.dietary_restrictions || [];
            document.getElementById('dietaryRestrictionsDisplay').textContent = 
                restrictions.length > 0 ? restrictions.join(', ') : 'None specified';
            
            // Health Goals
            const goals = preferences.goals || [];
            document.getElementById('healthGoalsDisplay').textContent = 
                goals.length > 0 ? goals.join(', ') : 'None specified';
        }
        
        function displayFallbackSettings() {
            // Show basic info from localStorage if available
            document.getElementById('userEmailDisplay').textContent = 
                localStorage.getItem('ftpEmail') || 'Not connected';
            document.getElementById('userPhoneDisplay').textContent = 
                formatPhoneNumber(getPhoneNumber()) || 'Not provided';
            
            // Show placeholders for other fields
            document.getElementById('householdSizeDisplay').textContent = 'Complete onboarding to see preferences';
            document.getElementById('mealTimingDisplay').textContent = 'Complete onboarding to see preferences';
            document.getElementById('favoriteMealsDisplay').textContent = 'Complete onboarding to see preferences';
            document.getElementById('cookingMethodsDisplay').textContent = 'Complete onboarding to see preferences';
            document.getElementById('dietaryRestrictionsDisplay').textContent = 'Complete onboarding to see preferences';
            document.getElementById('healthGoalsDisplay').textContent = 'Complete onboarding to see preferences';
        }
        
        function formatPhoneNumber(phone) {
            if (!phone) return '';
            // Format as (XXX) XXX-XXXX
            const cleaned = phone.replace(/\D/g, '');
            if (cleaned.length === 10) {
                return `(${cleaned.slice(0,3)}) ${cleaned.slice(3,6)}-${cleaned.slice(6)}`;
            }
            return phone;
        }
        
        async function refreshUserPreferences() {
            const button = event.currentTarget.querySelector('[style*="cursor: pointer"]');
            const originalText = button.textContent;
            
            try {
                button.textContent = '‚è≥ Loading...';
                await loadUserSettings();
                button.textContent = '‚úì Updated';
                setTimeout(() => {
                    button.textContent = originalText;
                }, 2000);
            } catch (error) {
                console.error('Error refreshing settings:', error);
                button.textContent = '‚ùå Error';
                setTimeout(() => {
                    button.textContent = originalText;
                }, 2000);
            }
        }
        
        function updateAccountCredentials() {
            const newEmail = prompt('Enter your new Farm to People email:', localStorage.getItem('ftpEmail') || '');
            if (!newEmail) return;
            
            const newPassword = prompt('Enter your new Farm to People password:');
            if (!newPassword) return;
            
            // Update localStorage
            localStorage.setItem('ftpEmail', newEmail);
            localStorage.setItem('ftpPassword', newPassword);
            
            // Update display
            document.getElementById('userEmailDisplay').textContent = newEmail;
            document.querySelector('.subtitle').textContent = newEmail;
            
            alert('Account credentials updated successfully!');
        }
        
        function updateMealSuggestions(meals) {
            const mealsHTML = meals.map((meal, index) => `
                <div class="cart-item" style="background: #f0f8f0; border-left: 3px solid #4169E1;">
                    <div class="item-details">
                        <div class="item-name" style="color: #4169E1; font-weight: 600;">${meal.name}</div>
                        <div class="item-meta">${meal.time} ‚Ä¢ ${meal.protein || '0'}g protein ‚Ä¢ ${meal.type || 'Dinner'}</div>
                    </div>
                    <div style="font-size: 12px; color: #6c757d;">Serves ${meal.servings || 2}</div>
                </div>
            `).join('');
            document.getElementById('suggestedMeals').innerHTML = mealsHTML;

            // Also update Meals tab with the first meal if we have one
            if (meals && meals.length > 0) {
                try {
                    if (typeof populateSimpleMealCard === 'function') {
                        populateSimpleMealCard(meals[0]);
                    }
                } catch (e) {
                    console.log('Note: Could not sync to Meals tab:', e.message);
                }
            }
        }

        function switchTab(tab, element) {
            console.log('üîÑ Switching to tab:', tab);

            // Special handling for settings - open modal instead
            if (tab === 'settings') {
                openSettingsModal();
                return; // Don't do normal tab switching
            }

            // Update active tab
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            element.classList.add('active');

            // Hide all tab contents first
            document.querySelectorAll('.tab-content').forEach(tc => tc.classList.remove('active'));

            // Hide all sections
            document.querySelectorAll('.section').forEach(s => s.classList.remove('active'));

            // Show the correct tab content
            if (tab === 'cart') {
                console.log('üì¶ Showing cart tab content');
                document.getElementById('boxTab').classList.add('active');
            } else if (tab === 'meals') {
                console.log('üçΩÔ∏è Showing meals tab content');
                document.getElementById('planTab').classList.add('active');
            }

            // Show the right section based on state and tab
            if (tab === 'cart') {
                // Cart tab shows saved data or allows new analysis
                if (currentState === 'complete') {
                    document.getElementById('cartAnalysisSection').classList.add('active');
                } else if (currentState === 'loading') {
                    document.getElementById('loadingSection').classList.add('active');
                } else {
                    // Try to load saved cart data first
                    loadSavedCartData().then(loaded => {
                        if (!loaded) {
                            // No saved data, show the start screen
                            document.getElementById('startSection').classList.add('active');
                        }
                    });
                }
            } else if (tab === 'meals') {
                // Meals tab shows meal suggestions
                document.getElementById('mealsSection').classList.add('active');

                // Show simple meal card if we have cart data, otherwise show empty state
                if (mealPlanData && mealPlanData.cart_data) {
                    // Show simple meal card instead of full calendar for now
                    document.getElementById('simpleMealCardContainer').style.display = 'block';
                    document.getElementById('mealPlanEmpty').style.display = 'none';
                    document.getElementById('mealCalendarGrid').style.display = 'none';

                    // Sync meals from Cart tab to Meals tab
                    setTimeout(() => {
                        syncMealsFromCart();
                    }, 100);
                } else {
                    // Show empty state
                    document.getElementById('simpleMealCardContainer').style.display = 'none';
                    document.getElementById('mealPlanEmpty').style.display = 'block';
                    document.getElementById('mealCalendarGrid').style.display = 'none';
                }
            }
            
            // Show header banner for cart and meals tabs
            if (tab === 'cart' || tab === 'meals') {
                document.querySelector('.header').style.display = 'block';
            }
        }

        // New function to open settings as modal with iframe
        function openSettingsModal() {
            console.log('üîß openSettingsModal called - using iframe approach');

            // Remove existing modal if it exists
            const existingModal = document.getElementById('settingsModalOverlay');
            if (existingModal) {
                existingModal.remove();
            }

            // Create overlay
            const overlay = document.createElement('div');
            overlay.id = 'settingsModalOverlay';
            overlay.style.cssText = `
                position: fixed;
                top: 0;
                left: 0;
                right: 0;
                bottom: 0;
                background: rgba(0,0,0,0.7);
                z-index: 9999;
                display: flex;
                align-items: center;
                justify-content: center;
                padding: 20px;
            `;

            // Create modal container
            const modal = document.createElement('div');
            modal.id = 'settingsModalWrapper';
            modal.style.cssText = `
                background: white;
                width: 100%;
                max-width: 800px;
                height: 90vh;
                border-radius: 16px;
                position: relative;
                overflow: hidden;
                box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            `;

            // Add close button
            const closeBtn = document.createElement('button');
            closeBtn.innerHTML = '√ó';
            closeBtn.style.cssText = `
                position: absolute;
                top: 15px;
                right: 20px;
                background: rgba(255,255,255,0.9);
                border: none;
                font-size: 24px;
                cursor: pointer;
                color: #666;
                line-height: 1;
                width: 32px;
                height: 32px;
                border-radius: 50%;
                z-index: 10000;
                display: flex;
                align-items: center;
                justify-content: center;
                transition: background-color 0.2s ease;
            `;
            closeBtn.onmouseover = () => closeBtn.style.backgroundColor = 'rgba(255,255,255,1)';
            closeBtn.onmouseout = () => closeBtn.style.backgroundColor = 'rgba(255,255,255,0.9)';
            closeBtn.onclick = closeSettingsModal;

            // Create iframe for settings page
            const iframe = document.createElement('iframe');
            const phone = localStorage.getItem('userPhone') || getPhoneNumber();
            iframe.src = `/settings?phone=${phone}&iframe=true`;
            iframe.style.cssText = `
                width: 100%;
                height: 100%;
                border: none;
                border-radius: 16px;
            `;

            // Add loading message while iframe loads
            const loadingDiv = document.createElement('div');
            loadingDiv.innerHTML = `
                <div style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); text-align: center;">
                    <div style="margin-bottom: 16px; font-size: 18px; color: #666;">Loading Settings...</div>
                    <div style="width: 40px; height: 40px; border: 3px solid #f3f3f3; border-top: 3px solid #007AFF; border-radius: 50%; animation: spin 1s linear infinite; margin: 0 auto;"></div>
                </div>
                <style>
                    @keyframes spin {
                        0% { transform: rotate(0deg); }
                        100% { transform: rotate(360deg); }
                    }
                </style>
            `;

            modal.appendChild(loadingDiv);
            modal.appendChild(iframe);
            modal.appendChild(closeBtn);

            // Hide loading message once iframe loads
            iframe.onload = () => {
                console.log('üîß Settings iframe loaded successfully');
                loadingDiv.style.display = 'none';
            };

            overlay.appendChild(modal);

            // Close on overlay click (but not on modal click)
            overlay.onclick = (e) => {
                if (e.target === overlay) {
                    closeSettingsModal();
                }
            };

            // Prevent modal clicks from closing
            modal.onclick = (e) => {
                e.stopPropagation();
            };

            document.body.appendChild(overlay);
            console.log('üîß Settings modal with iframe created');
        }

        function closeSettingsModal() {
            console.log('üîß Closing settings modal');
            const overlay = document.getElementById('settingsModalOverlay');
            if (overlay) {
                overlay.remove();
            }
        }

        function updateWeekDates() {
            const today = new Date();
            const monday = new Date(today);
            monday.setDate(today.getDate() - today.getDay() + 1);
            
            const days = ['monday', 'tuesday', 'wednesday', 'thursday', 'friday'];
            days.forEach((day, index) => {
                const date = new Date(monday);
                date.setDate(monday.getDate() + index);
                const dateElement = document.getElementById(`${day}-date`);
                if (dateElement) {
                    dateElement.textContent = date.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
                }
            });
        }
        
        // Initialize meal plan with proper ingredient tracking
        function initializeMealPlanFromCart() {
            if (!mealPlanData || !mealPlanData.cart_data) return;
            
            const cartData = mealPlanData.cart_data;
            
            // Build ingredient pool from cart data
            const ingredientPool = {};
            
            // Process individual items
            if (cartData.individual_items) {
                cartData.individual_items.forEach(item => {
                    ingredientPool[item.name] = {
                        total: item.quantity || 1,
                        allocated: 0,
                        remaining: item.quantity || 1,
                        unit: item.unit || 'piece'
                    };
                });
            }
            
            // Process box items
            ['customizable_boxes', 'non_customizable_boxes'].forEach(boxType => {
                if (cartData[boxType]) {
                    cartData[boxType].forEach(box => {
                        if (box.selected_items) {
                            box.selected_items.forEach(item => {
                                const name = item.name;
                                if (ingredientPool[name]) {
                                    ingredientPool[name].total += (item.quantity || 1);
                                    ingredientPool[name].remaining += (item.quantity || 1);
                                } else {
                                    ingredientPool[name] = {
                                        total: item.quantity || 1,
                                        allocated: 0,
                                        remaining: item.quantity || 1,
                                        unit: item.unit || 'piece'
                                    };
                                }
                            });
                        }
                    });
                }
            });
            
            // Store the meal plan structure
            mealPlanData.meal_plan = {
                ingredient_pool: ingredientPool,
                meals: {}
            };
            
            // Render the ingredient pool with actual tracking
            renderIngredientPool(ingredientPool);
            
            // Create sample meals with ingredient allocation (temporary until API generates real meals)
            generateSampleMealsWithIngredients();
        }
        
        // Generate sample meals with proper ingredient allocation
        function generateSampleMealsWithIngredients() {
            if (!mealPlanData.meal_plan) return;
            
            const days = ['monday', 'tuesday', 'wednesday', 'thursday', 'friday'];
            const sampleMeals = [
                { name: 'High-Protein Chicken Stir-Fry', protein: '38g', cook_time: '25 min', servings: 2 },
                { name: 'Mediterranean Quinoa Bowl', protein: '32g', cook_time: '30 min', servings: 2 },
                { name: 'Grass-Fed Beef Tacos', protein: '35g', cook_time: '20 min', servings: 4 },
                { name: 'Salmon & Roasted Vegetables', protein: '40g', cook_time: '35 min', servings: 2 },
                { name: 'Turkey Meatball Pasta', protein: '36g', cook_time: '30 min', servings: 3 }
            ];
            
            const pool = mealPlanData.meal_plan.ingredient_pool;
            const availableIngredients = Object.keys(pool).filter(ing => pool[ing].remaining > 0);
            
            days.forEach((day, index) => {
                const meal = sampleMeals[index % sampleMeals.length];
                const allocatedIngredients = [];
                
                // Allocate 2-3 random ingredients to each meal
                const numIngredients = Math.min(3, availableIngredients.length);
                for (let i = 0; i < numIngredients && availableIngredients.length > 0; i++) {
                    const ingIndex = Math.floor(Math.random() * availableIngredients.length);
                    const ingName = availableIngredients[ingIndex];
                    const ingredient = pool[ingName];
                    
                    if (ingredient.remaining > 0) {
                        const amount = Math.min(1, ingredient.remaining);
                        ingredient.allocated += amount;
                        ingredient.remaining -= amount;
                        
                        allocatedIngredients.push({
                            name: ingName,
                            amount: amount,
                            unit: ingredient.unit
                        });
                        
                        // Remove ingredient if fully allocated
                        if (ingredient.remaining <= 0) {
                            availableIngredients.splice(ingIndex, 1);
                        }
                    }
                }
                
                mealPlanData.meal_plan.meals[day] = {
                    id: `meal-${day}-${Date.now()}`,
                    meal_data: meal,
                    allocated_ingredients: allocatedIngredients
                };
                
                // Render the meal card
                renderMealCard(day, mealPlanData.meal_plan.meals[day]);
            });
            
            // Update ingredient pool display
            renderIngredientPool(pool);
        }
        
        // Render the full meal plan
        function renderFullMealPlan(mealPlan) {
            if (!mealPlan) return;
            
            // Render each meal
            if (mealPlan.meals) {
                Object.entries(mealPlan.meals).forEach(([day, meal]) => {
                    renderMealCard(day, meal);
                });
            }
            
            // Render ingredient pool
            if (mealPlan.ingredient_pool) {
                renderIngredientPool(mealPlan.ingredient_pool);
            }
        }
        
        function showAddToHomeScreen() {
            // iOS Safari
            if (navigator.userAgent.match(/iPhone|iPad|iPod/)) {
                alert('Tap the Share button (‚ÜóÔ∏è) at the bottom of Safari, then tap "Add to Home Screen"');
            } 
            // Android Chrome
            else if (navigator.userAgent.match(/Android/)) {
                alert('Tap the menu (‚ãÆ) in Chrome, then tap "Add to Home screen"');
            } 
            else {
                alert('Use your browser\'s menu to add this page to your home screen');
            }
        }

        // Save credentials when they complete onboarding (called from onboarding.js)
        window.saveUserCredentials = function(email, password) {
            localStorage.setItem('ftpEmail', email);
            localStorage.setItem('ftpPassword', password);
        }

        // ===== MEAL CALENDAR FUNCTIONALITY =====
        
        // Initialize to current date (will be set to Monday in initMealCalendar)
        let currentWeek = new Date();
        let currentMealPlan = null;
        let draggedMeal = null;
        
        // Initialize calendar when meals tab is clicked
        function initMealCalendar() {
            console.log('üçΩÔ∏è Initializing meal calendar');
            
            // Try to get delivery date from cart data to determine meal planning week
            const savedAnalysis = localStorage.getItem('cartAnalysisData');
            let targetDate = new Date(); // Default to current date
            
            if (savedAnalysis) {
                try {
                    const { cartData } = JSON.parse(savedAnalysis);
                    const deliveryInfo = cartData?.delivery_info;
                    
                    if (deliveryInfo && deliveryInfo.delivery_text) {
                        // Parse delivery date: "Shopping for: Sun, Aug 31, 10:00AM - 4:00PM"
                        console.log(`üîç Parsing delivery text: "${deliveryInfo.delivery_text}"`);
                        const match = deliveryInfo.delivery_text.match(/Shopping for: .+?(\w{3}), (\w{3}) (\d{1,2})/);
                        if (match) {
                            const month = match[2]; // "Aug"
                            const day = parseInt(match[3]); // 31
                            const currentYear = new Date().getFullYear();
                            
                            console.log(`üóìÔ∏è Parsed: ${month} ${day}, ${currentYear}`);
                            
                            // Convert month abbreviation to month number
                            const months = {
                                'Jan': 0, 'Feb': 1, 'Mar': 2, 'Apr': 3, 'May': 4, 'Jun': 5,
                                'Jul': 6, 'Aug': 7, 'Sep': 8, 'Oct': 9, 'Nov': 10, 'Dec': 11
                            };
                            
                            if (months[month] !== undefined) {
                                const deliveryDate = new Date(currentYear, months[month], day);
                                
                                // If the delivery date is in the past (more than 7 days ago), it's probably next year
                                const today = new Date();
                                const daysDiff = Math.floor((today - deliveryDate) / (1000 * 60 * 60 * 24));
                                if (daysDiff > 7) {
                                    deliveryDate.setFullYear(currentYear + 1);
                                }
                                
                                console.log(`üì¶ Delivery date: ${deliveryDate.toDateString()}`);
                                
                                // For Sunday delivery, meal planning week starts Monday
                                // Sunday Aug 31 -> Week of Sept 1-5
                                if (deliveryDate.getDay() === 0) { // Sunday
                                    targetDate = new Date(deliveryDate);
                                    targetDate.setDate(deliveryDate.getDate() + 1); // Monday Sept 1
                                    console.log(`üìÖ Sunday delivery, meal week starts Monday: ${targetDate.toDateString()}`);
                                } else {
                                    // For other days, start the following Monday
                                    targetDate = new Date(deliveryDate);
                                    const daysUntilMonday = (8 - deliveryDate.getDay()) % 7;
                                    targetDate.setDate(deliveryDate.getDate() + daysUntilMonday);
                                    console.log(`üìÖ ${['Sun','Mon','Tue','Wed','Thu','Fri','Sat'][deliveryDate.getDay()]} delivery, meal week starts: ${targetDate.toDateString()}`);
                                }
                            } else {
                                console.log(`‚ùå Unknown month: ${month}`);
                            }
                        } else {
                            console.log(`‚ùå Could not parse delivery text: "${deliveryInfo.delivery_text}"`);
                        }
                    } else {
                        console.log('‚ÑπÔ∏è No delivery info found, using current date');
                    }
                } catch (e) {
                    console.log('Could not parse delivery date, using current date');
                }
            }
            
            // Initialize currentWeek to the Monday of the target week
            console.log(`üìÖ Target date for meals: ${targetDate.toDateString()} (Day: ${targetDate.getDay()})`);
            
            // Ensure we have the correct Monday for the meal planning week
            currentWeek = getMonday(targetDate);
            console.log(`üìÖ Meal planning week Monday: ${currentWeek.toDateString()}`);
            console.log(`üìÖ Week string will be: ${getWeekString(currentWeek)}`);
            
            updateWeekDisplay();
            loadCurrentWeekPlan();
            setupEventListeners();
        }
        
        function setupEventListeners() {
            // Week navigation
            document.getElementById('prevWeek').addEventListener('click', () => {
                changeWeek(-1);
            });
            
            document.getElementById('nextWeek').addEventListener('click', () => {
                changeWeek(1);
            });
            
            // PDF generation
            document.getElementById('generatePDF').addEventListener('click', generateMealPlanPDF);
            
            // Auto-fill week
            document.getElementById('autoFillWeek').addEventListener('click', autoFillWeek);
            
            // Create meal plan (only if element exists)
            const createMealPlanBtn = document.getElementById('createMealPlan');
            if (createMealPlanBtn) {
                createMealPlanBtn.addEventListener('click', createNewMealPlan);
            }
            
            // Retry loading
            document.getElementById('retryLoad').addEventListener('click', loadCurrentWeekPlan);
            
            // Setup drag and drop
            setupDragAndDrop();
        }
        
        function getWeekString(date) {
            const monday = getMonday(date);
            return monday.toISOString().split('T')[0];
        }
        
        function getMonday(date) {
            const d = new Date(date);
            const day = d.getDay();
            
            // If it's already Monday, return it
            if (day === 1) {
                return new Date(d);
            }
            
            // If it's Sunday, go to next Monday
            if (day === 0) {
                const monday = new Date(d);
                monday.setDate(d.getDate() + 1);
                return monday;
            }
            
            // For other days, go to the Monday of that week
            const diff = d.getDate() - day + 1;
            const monday = new Date(d);
            monday.setDate(diff);
            return monday;
        }
        
        function updateWeekDisplay() {
            const monday = getMonday(currentWeek);
            const friday = new Date(monday);
            friday.setDate(friday.getDate() + 4);
            
            // Update the subtitle to show the date range
            const weekString = `${monday.toLocaleDateString('en-US', { 
                month: 'short', 
                day: 'numeric'
            })} - ${friday.toLocaleDateString('en-US', { 
                month: 'short', 
                day: 'numeric'
            })}`;
            
            document.getElementById('weekDisplay').textContent = weekString;
            
            // Update day dates
            const days = ['monday', 'tuesday', 'wednesday', 'thursday', 'friday'];
            days.forEach((day, index) => {
                const dayDate = new Date(monday);
                dayDate.setDate(dayDate.getDate() + index);
                const dateElement = document.getElementById(`${day}-date`);
                if (dateElement) {
                    dateElement.textContent = dayDate.toLocaleDateString('en-US', { 
                        month: 'short', 
                        day: 'numeric' 
                    });
                }
            });
        }
        
        function changeWeek(direction) {
            // Create a new date to avoid mutation issues
            const newWeek = new Date(currentWeek);
            newWeek.setDate(newWeek.getDate() + (direction * 7));
            currentWeek = newWeek;
            updateWeekDisplay();
            loadCurrentWeekPlan();
        }
        
        async function loadCurrentWeekPlan() {
            console.log('üìÖ Loading meal plan for week:', getWeekString(currentWeek));
            showLoading();
            
            try {
                const phone = getPhoneNumber();
                if (!phone) {
                    showEmpty();
                    return;
                }
                
                const weekString = getWeekString(currentWeek);
                const response = await fetch(`/api/meal-plans/${phone}/${weekString}`);
                
                if (response.status === 404) {
                    showEmpty();
                    return;
                }
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}`);
                }
                
                const mealPlan = await response.json();
                currentMealPlan = mealPlan;
                renderMealPlan(mealPlan);
                
            } catch (error) {
                console.error('Error loading meal plan:', error);
                showError();
            }
        }
        
        function getPhoneNumber() {
            // Try to get phone number from various sources
            const urlParams = new URLSearchParams(window.location.search);
            let phone = urlParams.get('phone');
            
            if (!phone) {
                phone = localStorage.getItem('userPhone');
            }
            
            // Fix truncated phone number issue
            if (phone === '425495323') {
                phone = '4254955323';
                // Update localStorage with correct number
                localStorage.setItem('userPhone', phone);
            }
            
            if (!phone) {
                // Try to extract from stored credentials or other sources
                phone = '4254955323'; // Default for testing
            }
            
            // Ensure consistent format (no +1)
            if (phone.startsWith('+1')) {
                phone = phone.substring(2);
            } else if (phone.startsWith('+')) {
                phone = phone.substring(1);
            } else if (phone.startsWith('1') && phone.length === 11) {
                phone = phone.substring(1);
            }
            
            return phone;
        }
        
        function showLoading() {
            document.getElementById('mealPlanLoading').style.display = 'block';
            document.getElementById('mealPlanError').style.display = 'none';
            document.getElementById('simpleMealCardContainer').style.display = 'none';
            document.getElementById('mealPlanEmpty').style.display = 'none';
            document.getElementById('mealCalendarGrid').style.display = 'none';
        }

        function showError() {
            document.getElementById('mealPlanLoading').style.display = 'none';
            document.getElementById('mealPlanError').style.display = 'block';
            document.getElementById('simpleMealCardContainer').style.display = 'none';
            document.getElementById('mealPlanEmpty').style.display = 'none';
            document.getElementById('mealCalendarGrid').style.display = 'none';
        }

        function showEmpty() {
            document.getElementById('mealPlanLoading').style.display = 'none';
            document.getElementById('mealPlanError').style.display = 'none';
            document.getElementById('simpleMealCardContainer').style.display = 'none';
            document.getElementById('mealPlanEmpty').style.display = 'block';
            document.getElementById('mealCalendarGrid').style.display = 'none';
        }

        function showMealCard() {
            document.getElementById('mealPlanLoading').style.display = 'none';
            document.getElementById('mealPlanError').style.display = 'none';
            document.getElementById('simpleMealCardContainer').style.display = 'block';
            document.getElementById('mealPlanEmpty').style.display = 'none';
            document.getElementById('mealCalendarGrid').style.display = 'none';
        }

        function showCalendar() {
            document.getElementById('mealPlanLoading').style.display = 'none';
            document.getElementById('mealPlanError').style.display = 'none';
            document.getElementById('simpleMealCardContainer').style.display = 'none';
            document.getElementById('mealPlanEmpty').style.display = 'none';
            document.getElementById('mealCalendarGrid').style.display = 'grid';
        }
        
        function renderMealPlan(mealPlan) {
            console.log('üé® Rendering meal plan:', mealPlan);
            
            showCalendar();
            updateWeekDisplay();
            
            // Clear existing meals
            const days = ['monday', 'tuesday', 'wednesday', 'thursday', 'friday'];
            days.forEach(day => {
                const mealSlot = document.querySelector(`[data-day="${day}"] .meal-slot`);
                if (mealSlot) {
                    mealSlot.innerHTML = `
                        <div class="add-meal-prompt">
                            <span class="add-icon">+</span>
                            <span>Add Meal</span>
                        </div>
                    `;
                }
            });
            
            // Render meals
            if (mealPlan.meals) {
                Object.entries(mealPlan.meals).forEach(([day, meal]) => {
                    renderMealCard(day, meal);
                });
            }
            
            // Render ingredients
            renderIngredientPool(mealPlan.ingredient_pool || {});
        }
        
        function renderMealCard(day, meal) {
            const mealSlot = document.querySelector(`[data-day="${day}"] .meal-slot`);
            if (!mealSlot) return;
            
            const mealData = meal.meal_data || {};
            const ingredients = meal.allocated_ingredients || [];
            
            const ingredientChips = ingredients.map(ing => 
                `<span class="ingredient-chip">${ing.name}</span>`
            ).join('');
            
            mealSlot.innerHTML = `
                <div class="meal-card" draggable="true" data-meal-id="${meal.id}" data-day="${day}">
                    <div class="meal-header">
                        <div class="meal-name">${mealData.name || 'Unnamed Meal'}</div>
                        <span class="protein-badge">${mealData.protein || '25g'} protein</span>
                    </div>
                    <div class="meal-details">
                        <span>${mealData.cook_time || '30 min'} ‚Ä¢ ${mealData.servings || 2} servings</span>
                    </div>
                    <div class="ingredients-used">
                        ${ingredientChips}
                    </div>
                    <div class="meal-actions">
                        <button class="meal-action-btn regenerate" onclick="regenerateMeal('${day}')">üîÑ</button>
                        <button class="meal-action-btn remove" onclick="removeMeal('${day}')">‚ùå</button>
                    </div>
                </div>
            `;
        }
        
        function renderIngredientPool(ingredientPool) {
            const ingredientList = document.getElementById('ingredientList');
            if (!ingredientList) return;
            
            const ingredientItems = Object.entries(ingredientPool).map(([name, info]) => {
                const usedPercent = (info.allocated / info.total) * 100;
                const remainingAmount = info.remaining;
                
                return `
                    <div class="ingredient-item">
                        <div class="ingredient-name">${name}</div>
                        <div class="ingredient-progress">
                            <div class="ingredient-progress-bar" style="width: ${usedPercent}%"></div>
                        </div>
                        <div class="ingredient-status">
                            <span>${remainingAmount} ${info.unit} left</span>
                            <span>${Math.round(usedPercent)}% used</span>
                        </div>
                    </div>
                `;
            }).join('');
            
            ingredientList.innerHTML = ingredientItems;
        }
        
        function setupDragAndDrop() {
            // Handle drag start
            document.addEventListener('dragstart', (e) => {
                if (e.target.classList.contains('meal-card')) {
                    draggedMeal = {
                        element: e.target,
                        day: e.target.dataset.day,
                        mealId: e.target.dataset.mealId
                    };
                    e.target.classList.add('dragging');
                }
            });
            
            // Handle drag end
            document.addEventListener('dragend', (e) => {
                if (e.target.classList.contains('meal-card')) {
                    e.target.classList.remove('dragging');
                }
                draggedMeal = null;
            });
            
            // Handle drag over
            document.addEventListener('dragover', (e) => {
                e.preventDefault();
                const mealSlot = e.target.closest('.meal-slot');
                if (mealSlot) {
                    const dayColumn = mealSlot.closest('.day-column');
                    if (dayColumn) {
                        dayColumn.classList.add('drag-over');
                    }
                }
            });
            
            // Handle drag leave
            document.addEventListener('dragleave', (e) => {
                const dayColumn = e.target.closest('.day-column');
                if (dayColumn) {
                    dayColumn.classList.remove('drag-over');
                }
            });
            
            // Handle drop
            document.addEventListener('drop', (e) => {
                e.preventDefault();
                
                const mealSlot = e.target.closest('.meal-slot');
                if (mealSlot && draggedMeal) {
                    const newDay = mealSlot.closest('.day-column').dataset.day;
                    
                    // Remove drag-over styling
                    document.querySelectorAll('.day-column').forEach(col => {
                        col.classList.remove('drag-over');
                    });
                    
                    if (newDay !== draggedMeal.day) {
                        moveMeal(draggedMeal.day, newDay, draggedMeal.mealId);
                    }
                }
            });
        }
        
        async function moveMeal(fromDay, toDay, mealId) {
            console.log(`üîÑ Moving meal from ${fromDay} to ${toDay}`);
            
            try {
                // Remove meal from old day
                await fetch(`/api/meal-plans/${currentMealPlan.id}/meals/${fromDay}`, {
                    method: 'DELETE'
                });
                
                // Get meal data for reassignment
                const mealCard = document.querySelector(`[data-meal-id="${mealId}"]`);
                if (!mealCard) return;
                
                // For now, just reload the plan
                // TODO: Implement proper meal reassignment
                setTimeout(() => {
                    loadCurrentWeekPlan();
                }, 500);
                
            } catch (error) {
                console.error('Error moving meal:', error);
                // Reload to show current state
                loadCurrentWeekPlan();
            }
        }
        
        async function regenerateMeal(day) {
            console.log(`üîÑ Regenerating meal for ${day}`);
            
            try {
                const response = await fetch(`/api/meal-plans/${currentMealPlan.id}/meals/${day}/regenerate`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        day: day,
                        preferences: {}
                    })
                });
                
                if (response.ok) {
                    // Show loading for this day
                    const mealSlot = document.querySelector(`[data-day="${day}"] .meal-slot`);
                    if (mealSlot) {
                        mealSlot.innerHTML = '<div class="spinner"></div>';
                    }
                    
                    // Reload after a few seconds
                    setTimeout(() => {
                        loadCurrentWeekPlan();
                    }, 3000);
                }
                
            } catch (error) {
                console.error('Error regenerating meal:', error);
            }
        }
        
        async function removeMeal(day) {
            if (!confirm(`Remove meal for ${day}?`)) return;
            
            console.log(`‚ùå Removing meal for ${day}`);
            
            try {
                const response = await fetch(`/api/meal-plans/${currentMealPlan.id}/meals/${day}`, {
                    method: 'DELETE'
                });
                
                if (response.ok) {
                    loadCurrentWeekPlan();
                }
                
            } catch (error) {
                console.error('Error removing meal:', error);
            }
        }
        
        async function createNewMealPlan() {
            console.log('üÜï Creating new meal plan');
            
            if (!mealPlanData || !mealPlanData.cart_data) {
                alert('Please analyze your cart first to create a meal plan');
                switchTab('cart');
                return;
            }
            
            try {
                const phone = getPhoneNumber();
                const weekString = getWeekString(currentWeek);
                
                const response = await fetch('/api/meal-plans/', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        user_phone: phone,
                        week_of: weekString,
                        cart_data: mealPlanData.cart_data
                    })
                });
                
                if (response.ok) {
                    showLoading();
                    // Wait a bit for background processing
                    setTimeout(() => {
                        loadCurrentWeekPlan();
                    }, 5000);
                } else {
                    throw new Error(`HTTP ${response.status}`);
                }
                
            } catch (error) {
                console.error('Error creating meal plan:', error);
                alert('Failed to create meal plan. Please try again.');
            }
        }
        
        async function autoFillWeek() {
            console.log('üéØ Auto-filling week with meals');
            // For now, just create a new meal plan
            await createNewMealPlan();
        }
        
        function generateMealPlanPDF() {
            console.log('üìÑ Generating meal plan PDF');
            if (currentMealPlan) {
                // TODO: Implement PDF generation
                alert('PDF generation coming soon!');
            }
        }
        
        // Enhanced switchTab function to initialize calendar
        const originalSwitchTab = switchTab;
        window.switchTab = function(tab, element) {
            originalSwitchTab(tab, element);
            
            if (tab === 'meals') {
                // Initialize calendar when switching to meals tab
                setTimeout(() => {
                    initMealCalendar();
                }, 100);
            }
        };
        
        // Settings Management
        let currentUserSettings = {};
        let settingsOptions = {};
        let currentEditCategory = null;
        
        async function loadUserSettings() {
            const phone = localStorage.getItem('userPhone') || '4254955323';
            document.getElementById('settingsLoading').style.display = 'block';
            document.getElementById('settingsCategories').style.display = 'none';
            
            try {
                // Load user preferences
                const userResponse = await fetch(`/api/settings/${phone}`);
                const userData = await userResponse.json();
                currentUserSettings = userData;
                
                // Load available options
                const optionsResponse = await fetch('/api/settings/options');
                settingsOptions = await optionsResponse.json();
                
                // Display settings
                displaySettings();
            } catch (error) {
                console.error('Error loading settings:', error);
                document.getElementById('settingsCategories').innerHTML = '<p style="text-align: center; color: #dc3545;">Failed to load settings</p>';
            } finally {
                document.getElementById('settingsLoading').style.display = 'none';
                document.getElementById('settingsCategories').style.display = 'grid';
            }
        }
        
        function displaySettings() {
            const categories = [
                {
                    key: 'household_size',
                    icon: 'üë•',
                    title: 'Household Size',
                    getValue: () => currentUserSettings.household_size || '1-2 people'
                },
                {
                    key: 'meal_timing',
                    icon: 'üç¥',
                    title: 'Meal Preferences',
                    getValue: () => {
                        const timing = currentUserSettings.meal_timing;
                        if (Array.isArray(timing)) return timing.join(', ');
                        return timing || 'Dinner';
                    }
                },
                {
                    key: 'cooking_methods',
                    icon: 'üë®‚Äçüç≥',
                    title: 'Cooking Style',
                    getValue: () => {
                        const methods = currentUserSettings.cooking_methods || [];
                        return methods.length ? `${methods.length} preferences` : 'Not set';
                    }
                },
                {
                    key: 'dietary_restrictions',
                    icon: 'ü•ó',
                    title: 'Dietary Restrictions',
                    getValue: () => {
                        const restrictions = currentUserSettings.dietary_restrictions || [];
                        return restrictions.length ? restrictions.join(', ') : 'None';
                    }
                },
                {
                    key: 'goals',
                    icon: 'üéØ',
                    title: 'Health Goals',
                    getValue: () => {
                        const goals = currentUserSettings.goals || [];
                        return goals.length ? goals.join(', ') : 'Not set';
                    }
                }
            ];
            
            const html = categories.map(cat => `
                <div class="category-card" style="background: white; border-radius: 12px; padding: 20px; border: 1px solid #e9ecef; transition: all 0.2s ease;">
                    <div style="display: flex; align-items: center; justify-content: space-between;">
                        <div style="display: flex; align-items: center; gap: 12px;">
                            <span style="font-size: 24px;">${cat.icon}</span>
                            <div>
                                <div style="font-size: 18px; font-weight: 600;">${cat.title}</div>
                                <div style="color: #6c757d; font-size: 14px;">${cat.getValue()}</div>
                            </div>
                        </div>
                        <span style="color: #adb5bd; font-size: 20px;">‚Ä∫</span>
                    </div>
                </div>
            `).join('');
            
            document.getElementById('settingsCategories').innerHTML = html;
        }

        // Sync Meals From Cart Tab Functions
        function syncMealsFromCart() {
            console.log('üîÑ Syncing meals from Cart tab to Meals tab');

            // Try to get cached meal suggestions from localStorage first
            const cachedMeals = localStorage.getItem('cachedMealSuggestions');
            if (cachedMeals) {
                try {
                    const meals = JSON.parse(cachedMeals);
                    if (meals && meals.length > 0) {
                        console.log('‚úÖ Found cached meal suggestions:', meals.length, 'meals');
                        populateSimpleMealCard(meals[0]); // Use first meal as featured
                        return;
                    }
                } catch (e) {
                    console.log('‚ö†Ô∏è Could not parse cached meals');
                }
            }

            // Fall back to trying to extract from Cart tab DOM
            const mealSuggestionsContainer = document.getElementById('mealSuggestionsContainer');
            if (mealSuggestionsContainer && mealSuggestionsContainer.children.length > 0) {
                console.log('‚úÖ Found meal suggestions in Cart tab DOM');
                // Extract meal data from first card
                const firstMealCard = mealSuggestionsContainer.children[0];
                const mealName = firstMealCard.querySelector('.meal-name')?.textContent;
                const mealMeta = firstMealCard.querySelector('.meal-meta')?.textContent;

                if (mealName && mealMeta) {
                    // Parse meta info (e.g., "25 mins ‚Ä¢ 32g protein ‚Ä¢ Dinner")
                    const metaParts = mealMeta.split(' ‚Ä¢ ');
                    const meal = {
                        name: mealName,
                        time: metaParts[0] || '30 mins',
                        protein: metaParts[1] || '25g protein',
                        type: metaParts[2] || 'Dinner'
                    };
                    populateSimpleMealCard(meal);
                    return;
                }
            }

            // If no meals found, show empty state
            console.log('‚ùå No meal suggestions found - showing empty state');
            showEmptyMealState();
        }

        function populateSimpleMealCard(meal) {
            console.log('üçΩÔ∏è Populating Meals tab with GPT-generated meal:', meal);

            // Check if all required elements exist
            const mealTitle = document.getElementById('mealTitle');
            const mealTime = document.getElementById('mealTime');
            const ingredientsList = document.getElementById('simpleMealIngredients');
            const simpleMealCard = document.getElementById('simpleMealCard');

            if (!mealTitle || !mealTime || !ingredientsList || !simpleMealCard) {
                console.log('‚ùå Meal card elements not found');
                return;
            }

            // Update with actual meal data from GPT
            mealTitle.textContent = meal.name;
            mealTime.textContent = meal.time;

            // Show ingredients used (if available)
            if (meal.ingredients_used && meal.ingredients_used.length > 0) {
                const ingredientItems = meal.ingredients_used.map(ingredient => `
                    <div class="ingredient-tag">${ingredient}</div>
                `).join('');
                ingredientsList.innerHTML = `<div>Uses from your cart:</div>${ingredientItems}`;
            } else {
                // Generic message if no specific ingredients listed
                ingredientsList.innerHTML = `<div class="ingredient-tag">Uses ingredients from your cart</div>`;
            }

            // Show the card
            showMealCard();

            console.log('‚úÖ Meals tab updated with GPT meal successfully');
        }

        function showEmptyMealState() {
            console.log('üì≠ Showing empty meal state');
            const mealTitle = document.getElementById('mealTitle');
            const mealTime = document.getElementById('mealTime');
            const ingredientsList = document.getElementById('simpleMealIngredients');

            if (mealTitle) mealTitle.textContent = 'üçΩÔ∏è Suggested Meal';
            if (mealTime) mealTime.textContent = 'Analyze cart first';
            if (ingredientsList) ingredientsList.innerHTML = '<div class="ingredient-tag">No meal suggestions yet</div>';
        }

        async function regenerateSimpleMeal() {
            console.log('üîÑ Regenerating simple meal using Cart tab API...');

            const button = document.getElementById('regenerateMeal');
            if (!button) {
                console.log('‚ùå Regenerate button not found');
                return;
            }

            const originalText = button.textContent;
            button.textContent = 'Generating...';
            button.disabled = true;

            try {
                // Use the same API endpoint that Cart tab uses
                const storedData = localStorage.getItem('cartAnalysisData');
                if (!storedData) {
                    throw new Error('No cart data available - analyze cart first');
                }

                const { cartData } = JSON.parse(storedData);

                console.log('üçΩÔ∏è Calling same API as Cart tab for meal suggestions...');
                const response = await fetch('/api/refresh-meals', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({
                        cart_data: cartData,
                        phone: localStorage.getItem('userPhone')
                    })
                });

                const data = await response.json();

                if (data.success && data.meals && data.meals.length > 0) {
                    console.log('‚úÖ Got new meal suggestion:', data.meals[0]);

                    // Update localStorage so Cart tab also shows the new meals
                    localStorage.setItem('cachedMealSuggestions', JSON.stringify(data.meals));
                    localStorage.setItem('cachedMealSuggestionsTimestamp', Date.now().toString());

                    // Update Meals tab display with first meal
                    populateSimpleMealCard(data.meals[0]);

                    // Also update Cart tab if it exists
                    if (typeof updateMealSuggestions === 'function') {
                        updateMealSuggestions(data.meals);
                    }
                } else {
                    throw new Error(data.error || 'Failed to generate new meal');
                }

            } catch (error) {
                console.error('‚ùå Error regenerating meal:', error);
                alert('Failed to generate new meal. Please try again.');
            } finally {
                button.textContent = originalText;
                button.disabled = false;
            }
        }

    </script>

</body>
</html>