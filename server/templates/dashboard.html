<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Your Meal Plan - Farm to People</title>
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #f8f9fa;
            padding-bottom: 80px; /* Space for bottom tabs */
        }

        /* Top Header */
        .header {
            background: white;
            padding: 20px;
            border-bottom: 1px solid #e9ecef;
            position: sticky;
            top: 0;
            z-index: 100;
        }

        .header h1 {
            font-size: 24px;
            color: #212529;
            margin-bottom: 4px;
        }

        .header .subtitle {
            color: #6c757d;
            font-size: 14px;
        }

        /* Main Content Area */
        .content {
            padding: 20px;
            max-width: 600px;
            margin: 0 auto;
            min-height: calc(100vh - 200px);
        }

        /* Start Screen - Before Analysis */
        .start-screen {
            text-align: center;
            padding: 40px 20px;
        }

        .start-icon {
            font-size: 48px;
            margin-bottom: 20px;
        }

        .start-title {
            font-size: 24px;
            font-weight: 600;
            color: #212529;
            margin-bottom: 8px;
        }

        .start-description {
            font-size: 16px;
            color: #6c757d;
            margin-bottom: 24px;
            line-height: 1.4;
        }

        .analyze-button {
            background: #28a745;
            color: white;
            border: none;
            padding: 18px 40px;
            font-size: 18px;
            font-weight: 600;
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.2s ease;
            display: inline-block;
        }

        .analyze-button:hover {
            background: #218838;
            transform: translateY(-2px);
        }

        .analyze-button:active {
            transform: translateY(0);
        }

        /* Loading State */
        .loading-screen {
            text-align: center;
            padding: 60px 20px;
            display: none;
        }

        .loading-animation {
            width: 80px;
            height: 80px;
            margin: 0 auto 24px;
            border: 4px solid #e9ecef;
            border-top: 4px solid #28a745;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .loading-title {
            font-size: 24px;
            font-weight: 600;
            color: #212529;
            margin-bottom: 12px;
        }

        .loading-status {
            font-size: 16px;
            color: #6c757d;
            margin-bottom: 8px;
        }

        .loading-tip {
            background: #e3f2fd;
            border-radius: 12px;
            padding: 20px;
            margin-top: 32px;
            max-width: 400px;
            margin-left: auto;
            margin-right: auto;
        }

        .loading-tip h3 {
            font-size: 16px;
            color: #1976d2;
            margin-bottom: 12px;
        }

        .loading-tip p {
            font-size: 14px;
            color: #495057;
            line-height: 1.4;
            margin-bottom: 16px;
        }

        .home-screen-prompt {
            background: white;
            border: 2px solid #1976d2;
            border-radius: 8px;
            padding: 12px;
            font-size: 14px;
            color: #1976d2;
            font-weight: 500;
            cursor: pointer;
            text-decoration: none;
            display: inline-block;
        }

        /* Cart Analysis Display */
        .cart-analysis {
            display: none;
        }

        .cart-section {
            background: white;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
        }

        .section-header {
            font-size: 18px;
            font-weight: 600;
            color: #212529;
            margin-bottom: 16px;
            padding-bottom: 8px;
            border-bottom: 2px solid #e9ecef;
        }

        .item-grid {
            display: grid;
            gap: 12px;
        }

        .cart-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px;
            background: #f8f9fa;
            border-radius: 8px;
        }

        .item-details {
            flex: 1;
        }

        .item-name {
            font-size: 14px;
            font-weight: 600;
            color: #4169E1; /* Penny blue for item names */
            margin-bottom: 4px;
        }

        .item-meta {
            font-size: 12px;
            color: #6c757d;
        }

        .item-price {
            font-size: 14px;
            font-weight: 600;
            color: #28a745;
        }

        .box-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
        }

        .box-name {
            font-size: 16px;
            font-weight: 600;
            color: #212529;
        }

        .box-status {
            font-size: 12px;
            color: #6c757d;
            background: #e9ecef;
            padding: 4px 8px;
            border-radius: 4px;
        }

        .swap-suggestion {
            background: #fff3cd;
            border-left: 4px solid #ffc107;
            padding: 12px;
            margin-bottom: 12px;
            border-radius: 4px;
        }

        .swap-text {
            font-size: 14px;
            color: #856404;
        }

        .addon-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px;
            background: #d4edda;
            border-radius: 8px;
            margin-bottom: 8px;
        }

        /* Bottom Tab Navigation */
        .bottom-tabs {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: #4169E1; /* Penny blue background */
            border-top: 1px solid #3557d1;
            display: flex;
            justify-content: space-around;
            padding: 8px 0;
            padding-bottom: calc(8px + env(safe-area-inset-bottom)); /* iPhone safe area */
            z-index: 1000;
        }

        .tab {
            flex: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 8px;
            text-decoration: none;
            color: rgba(255, 255, 255, 0.7); /* White text, semi-transparent */
            transition: all 0.2s ease;
        }

        .tab.active {
            color: white; /* Pure white when active */
        }

        .tab-icon {
            width: 20px;
            height: 20px;
            margin-bottom: 4px;
            fill: currentColor;
        }

        .tab-label {
            font-size: 11px;
            font-weight: 500;
        }

        /* 2D SVG Icons */
        .icon-home {
            fill: currentColor;
        }

        .icon-cart {
            fill: currentColor;
        }

        .icon-settings {
            fill: currentColor;
        }

        /* Tighter layout */
        .content {
            padding: 16px;
            max-width: 600px;
            margin: 0 auto;
            min-height: calc(100vh - 180px);
        }

        .cart-section {
            background: white;
            border-radius: 8px;
            padding: 16px;
            margin-bottom: 16px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.05);
        }

        .section-header {
            font-size: 16px;
            font-weight: 600;
            color: #212529;
            margin-bottom: 12px;
            padding-bottom: 6px;
            border-bottom: 1px solid #e9ecef;
        }

        .item-grid {
            display: grid;
            gap: 8px;
        }

        .cart-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px;
            background: #f8f9fa;
            border-radius: 6px;
        }

        /* Hide sections by default */
        .section {
            display: none;
        }

        .section.active {
            display: block;
        }

        /* Responsive adjustments */
        @media (max-width: 380px) {
            .start-title {
                font-size: 24px;
            }
            
            .start-description {
                font-size: 16px;
            }
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>Cart Analysis</h1>
        <p class="subtitle" id="headerSubtitle">Ready to analyze your cart</p>
    </div>

    <div class="content">
        <!-- Start Screen - Shows First -->
        <div class="start-screen section active" id="startSection">
            <div class="start-icon">üì¶</div>
            <h2 class="start-title">Cart Analysis</h2>
            <p class="start-description">
                See what's in your Farm to People cart, suggested swaps, and add-ons.
            </p>
            <button class="analyze-button" onclick="startAnalysis()">
                Analyze My Cart
            </button>
        </div>

        <!-- Loading Screen - Shows During Analysis -->
        <div class="loading-screen section" id="loadingSection">
            <div class="loading-animation"></div>
            <h2 class="loading-title">Analyzing Your Cart</h2>
            <p class="loading-status" id="loadingStatus">Logging into Farm to People...</p>
            
            <div class="loading-tip">
                <h3>While you wait (20-30 seconds)</h3>
                <p>Add this page to your home screen for easy access:</p>
                <button class="home-screen-prompt" onclick="showAddToHomeScreen()">
                    Add to Home Screen
                </button>
            </div>
        </div>

        <!-- Cart Analysis Display - Shows After Analysis -->
        <div class="cart-analysis section" id="cartAnalysisSection">
            <!-- Suggested Meals - TOP PRIORITY -->
            <div class="cart-section" id="suggestedMealsSection">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px;">
                    <h3 class="section-header" style="margin: 0;">Suggested Meals</h3>
                    <button id="refreshCartButton" onclick="refreshCartData()" 
                            style="background: #007AFF; color: white; border: none; border-radius: 8px; padding: 8px 16px; font-size: 14px; font-weight: 600; cursor: pointer;">
                        üîÑ Refresh Cart
                    </button>
                </div>
                <div id="suggestedMeals">
                    <!-- Suggested meals based on preferences will be inserted here -->
                </div>
            </div>

            <!-- Individual Items -->
            <div class="cart-section" id="individualItemsSection">
                <h3 class="section-header">Individual Items</h3>
                <div class="item-grid" id="individualItems">
                    <!-- Individual items will be inserted here -->
                </div>
            </div>

            <!-- Customizable Boxes -->
            <div class="cart-section" id="customizableBoxesSection">
                <h3 class="section-header">Customizable Boxes</h3>
                <div id="customizableBoxes">
                    <!-- Customizable box data will be inserted here -->
                </div>
            </div>

            <!-- Non-Customizable Boxes -->
            <div class="cart-section" id="nonCustomizableBoxesSection">
                <h3 class="section-header">Fixed Boxes</h3>
                <div id="nonCustomizableBoxes">
                    <!-- Non-customizable box data will be inserted here -->
                </div>
            </div>

            <!-- Suggested Swaps -->
            <div class="cart-section" id="swapsSection">
                <h3 class="section-header">Suggested Swaps</h3>
                <div id="suggestedSwaps">
                    <!-- Swap suggestions will be inserted here -->
                </div>
            </div>

            <!-- Recommended Add-ons -->
            <div class="cart-section" id="addonsSection">
                <h3 class="section-header">Recommended Add-ons</h3>
                <div id="recommendedAddons">
                    <!-- Add-on recommendations will be inserted here -->
                </div>
            </div>
        </div>

        <!-- Meals View - Shows suggested meals based on cart -->
        <div class="meals-view section" id="mealsSection">
            <h2>üçΩÔ∏è Suggested Meals</h2>
            <p style="color: #6c757d; margin-top: 20px;">Based on your cart contents</p>
            
            <!-- Refresh button for new suggestions -->
            <div style="text-align: center; margin: 20px 0;">
                <button id="refreshMeals" class="analyze-button" style="background: #6c757d; padding: 12px 24px;">
                    üîÑ Try Different Meals (<span id="refreshCount">3</span> left)
                </button>
            </div>
            
            <!-- Meal suggestions will be dynamically added here -->
            <div id="mealSuggestionsContainer"></div>
        </div>

        <!-- Settings - Hidden for now -->
        <div class="settings-view section" id="settingsSection">
            <h2>Settings</h2>
            <p style="color: #6c757d; margin-top: 20px;">Preferences and account settings</p>
        </div>
    </div>

    <!-- Bottom Tab Navigation -->
    <nav class="bottom-tabs">
        <a href="#cart" class="tab active" onclick="switchTab('cart', this)">
            <svg class="tab-icon icon-cart" viewBox="0 0 24 24">
                <circle cx="8" cy="21" r="1"/>
                <circle cx="19" cy="21" r="1"/>
                <path d="m2.05 2.05h2l2.66 12.42a2 2 0 0 0 2 1.58h9.78a2 2 0 0 0 1.95-1.57l1.65-7.43H5.12"/>
            </svg>
            <span class="tab-label">Cart</span>
        </a>
        <a href="#meals" class="tab" onclick="switchTab('meals', this)">
            <svg class="tab-icon icon-meals" viewBox="0 0 24 24">
                <path d="M8.1 13.34l2.83-2.83L3.91 3.5c-1.56 1.56-1.56 4.09 0 5.66l4.19 4.18zm6.78-1.81c1.53.71 3.68.21 5.27-1.38 1.91-1.91 2.28-4.65.81-6.12-1.46-1.46-4.2-1.1-6.12.81-1.59 1.59-2.09 3.74-1.38 5.27L3.7 19.87l1.41 1.41L12 14.41l6.88 6.88 1.41-1.41L13.41 11.73z"/>
            </svg>
            <span class="tab-label">Meals</span>
        </a>
        <a href="/settings" class="tab">
            <svg class="tab-icon icon-settings" viewBox="0 0 24 24">
                <path d="M12 8c-2.21 0-4 1.79-4 4s1.79 4 4 4 4-1.79 4-4-1.79-4-4-4zm8.94 3c-.46-4.17-3.77-7.48-7.94-7.94V1h-2v2.06C6.83 3.52 3.52 6.83 3.06 11H1v2h2.06c.46 4.17 3.77 7.48 7.94 7.94V23h2v-2.06c4.17-.46 7.48-3.77 7.94-7.94H23v-2h-2.06zM12 19c-3.87 0-7-3.13-7-7s3.13-7 7-7 7 3.13 7 7-3.13 7-7 7z"/>
            </svg>
            <span class="tab-label">Settings</span>
        </a>
    </nav>

    <script>
        let currentState = 'start'; // start, loading, complete
        let mealPlanData = null;
        let refreshesLeft = 3;  // Track refresh count

        // Check if we have saved credentials
        const userEmail = localStorage.getItem('ftpEmail');
        if (userEmail) {
            document.querySelector('.subtitle').textContent = userEmail;
        }

        async function startAnalysis() {
            // Switch to loading state
            currentState = 'loading';
            document.getElementById('startSection').classList.remove('active');
            document.getElementById('loadingSection').classList.add('active');
            document.getElementById('headerSubtitle').textContent = 'Analyzing...';

            // Update loading status messages
            const statuses = [
                'Logging into Farm to People...',
                'Found your account! Loading cart...',
                'Analyzing your produce selections...',
                'Creating personalized meal plans...',
                'Almost done...'
            ];

            let statusIndex = 0;
            const statusInterval = setInterval(() => {
                if (statusIndex < statuses.length) {
                    document.getElementById('loadingStatus').textContent = statuses[statusIndex];
                    statusIndex++;
                }
            }, 3000);

            try {
                // Get user phone (from localStorage or prompt)
                let userPhone = localStorage.getItem('userPhone');
                if (!userPhone) {
                    userPhone = prompt('Enter your phone number to analyze your cart:');
                    if (userPhone) {
                        localStorage.setItem('userPhone', userPhone);
                    }
                }
                
                // Start the actual analysis
                // Pass phone number to use stored credentials from database
                const response = await fetch('/api/analyze-cart', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({
                        phone: userPhone,
                        use_mock: false  // Set to true to use mock data for testing
                    })
                });

                const data = await response.json();
                clearInterval(statusInterval);

                if (data.success) {
                    showCartAnalysis(data.cart_data);
                } else {
                    // For now, show mock data
                    showMockCartAnalysis();
                }
            } catch (error) {
                clearInterval(statusInterval);
                // Show mock data for testing
                showMockCartAnalysis();
            }
        }

        function showMockCartAnalysis() {
            // Real cart data from last week's scraping
            const realCartData = {
                individual_items: [
                    {name: "Pasture Raised Eggs", quantity: 1, unit: "1 dozen", price: "$7.49", type: "individual"},
                    {name: "Organic & Fair Trade Hass Avocados", quantity: 5, unit: "1 piece", price: "$12.50", type: "individual"},
                    {name: "Organic & Fair Trade Bananas (Ripe)", quantity: 1, unit: "1 bunch", price: "$2.49", type: "individual"}
                ],
                customizable_boxes: [
                    {
                        box_name: "The Cook's Box - Paleo",
                        selected_items: [
                            {name: "Boneless, Skinless Chicken Breast", unit: ".7-1lb", producer: "Locust Point Farm"},
                            {name: "Black Sea Bass", unit: "8.0 oz", producer: "Red's Best Seafood"},
                            {name: "Local Yellow Peaches", unit: "2 pieces", producer: "Lancaster Farm Fresh Cooperative"},
                            {name: "Organic Leaf Lettuce", unit: "1 head", producer: "Sun Sprout Farm"},
                            {name: "Mixed Cherry Tomatoes", unit: "1 pint", producer: "Eagle Road Farm"},
                            {name: "Lunchbox Peppers", unit: "12.0 oz", producer: "Sunny Harvest"},
                            {name: "Organic Italian Eggplant", unit: "1 piece", producer: "Lancaster Farm Fresh Cooperative"},
                            {name: "Unagi Cucumbers", unit: "2 pieces", producer: "Sunny Harvest"},
                            {name: "Organic Green Zucchini", unit: "2 pieces", producer: "Sun Sprout Farm"}
                        ],
                        available_alternatives: [
                            {name: "White Ground Turkey", unit: "1.0 Lbs", producer: "Koch's Turkey Farm"},
                            {name: "Pork Kielbasa", unit: "1 Lbs", producer: "Autumn's Harvest"},
                            {name: "Yellow Nectarines", unit: "2 pieces", producer: "Weaver's Orchard"},
                            {name: "Red Onions", unit: "2 Lbs", producer: "Dagele Brothers Produce"},
                            {name: "Yellow Onions", unit: "2.0 Lbs", producer: "Dagele Brothers Produce"}
                        ],
                        selected_count: 9,
                        alternatives_count: 10
                    }
                ],
                non_customizable_boxes: [
                    {
                        box_name: "Seasonal Fruit Medley",
                        selected_items: [
                            {name: "Prune Plums", unit: "1 Lbs"},
                            {name: "Honeycrisp Apples", unit: "2 pieces"},
                            {name: "Local Yellow Peaches", unit: "2 pieces"}
                        ],
                        selected_count: 3,
                        customizable: false
                    }
                ]
            };
            showCartAnalysis(realCartData);
        }

        function showCartAnalysis(cartData) {
            currentState = 'complete';
            document.getElementById('loadingSection').classList.remove('active');
            document.getElementById('cartAnalysisSection').classList.add('active');
            document.getElementById('headerSubtitle').textContent = 'Cart analysis complete';

            // Generate suggested meals based on cart contents (prioritize dinner)
            const suggestedMeals = generateMealSuggestions(cartData);
            const mealsHTML = suggestedMeals.map((meal, index) => `
                <div class="cart-item" style="background: #f0f8f0; border-left: 3px solid #4169E1;">
                    <div class="item-details">
                        <div class="item-name" style="color: #4169E1; font-weight: 600;">${meal.name}</div>
                        <div class="item-meta">${meal.time} min ‚Ä¢ ${meal.protein}g protein ‚Ä¢ ${meal.type}</div>
                    </div>
                    <div style="font-size: 12px; color: #6c757d;">Serves ${meal.servings}</div>
                </div>
            `).join('');
            document.getElementById('suggestedMeals').innerHTML = mealsHTML;

            // Show individual items
            if (cartData.individual_items && cartData.individual_items.length > 0) {
                const individualHTML = cartData.individual_items.map(item => `
                    <div class="cart-item">
                        <div class="item-details">
                            <div class="item-name">${item.name}</div>
                            <div class="item-meta">${item.quantity} ${item.unit}</div>
                        </div>
                        <div class="item-price">${item.price || 'N/A'}</div>
                    </div>
                `).join('');
                document.getElementById('individualItems').innerHTML = individualHTML;
            } else {
                document.getElementById('individualItemsSection').style.display = 'none';
            }

            // Show customizable boxes
            if (cartData.customizable_boxes && cartData.customizable_boxes.length > 0) {
                const customizableHTML = cartData.customizable_boxes.map(box => `
                    <div style="margin-bottom: 20px;">
                        <div class="box-header">
                            <div class="box-name">${box.box_name}</div>
                            <div class="box-status">${box.alternatives_count} available alternatives</div>
                        </div>
                        <div class="item-grid">
                            ${box.selected_items.map(item => `
                                <div class="cart-item">
                                    <div class="item-details">
                                        <div class="item-name">${item.name}</div>
                                        <div class="item-meta">${item.unit} ‚Ä¢ ${item.producer || 'Farm Fresh'}</div>
                                    </div>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                `).join('');
                document.getElementById('customizableBoxes').innerHTML = customizableHTML;
            } else {
                document.getElementById('customizableBoxesSection').style.display = 'none';
            }

            // Show non-customizable boxes
            if (cartData.non_customizable_boxes && cartData.non_customizable_boxes.length > 0) {
                const nonCustomizableHTML = cartData.non_customizable_boxes.map(box => `
                    <div style="margin-bottom: 20px;">
                        <div class="box-header">
                            <div class="box-name">${box.box_name}</div>
                            <div class="box-status">Fixed selection</div>
                        </div>
                        <div class="item-grid">
                            ${box.selected_items.map(item => `
                                <div class="cart-item">
                                    <div class="item-details">
                                        <div class="item-name">${item.name}</div>
                                        <div class="item-meta">${item.unit}</div>
                                    </div>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                `).join('');
                document.getElementById('nonCustomizableBoxes').innerHTML = nonCustomizableHTML;
            } else {
                document.getElementById('nonCustomizableBoxesSection').style.display = 'none';
            }

            // Show suggested swaps (mock for now)
            const swapsHTML = `
                <div class="swap-suggestion">
                    <div class="swap-text">Consider swapping Ribeye Steak ‚Üí Salmon Fillet for omega-3s</div>
                </div>
                <div class="swap-suggestion">
                    <div class="swap-text">Add Organic Spinach (missing greens for balanced nutrition)</div>
                </div>
            `;
            document.getElementById('suggestedSwaps').innerHTML = swapsHTML;

            // Show recommended add-ons (mock for now)
            const addonsHTML = `
                <div class="addon-item">
                    <div class="item-details">
                        <div class="item-name">Organic Olive Oil</div>
                        <div class="item-meta">Essential for cooking your proteins</div>
                    </div>
                    <div class="item-price">$12.99</div>
                </div>
                <div class="addon-item">
                    <div class="item-details">
                        <div class="item-name">Sea Salt</div>
                        <div class="item-meta">Perfect for seasoning</div>
                    </div>
                    <div class="item-price">$6.50</div>
                </div>
            `;
            document.getElementById('recommendedAddons').innerHTML = addonsHTML;
        }

        function generateMealSuggestions(cartData) {
            // Analyze cart contents to suggest meals
            const proteins = [];
            const vegetables = [];
            
            // Extract proteins and vegetables from cart
            cartData.customizable_boxes?.forEach(box => {
                box.selected_items.forEach(item => {
                    if (item.name.includes('Chicken') || item.name.includes('Bass') || item.name.includes('Turkey')) {
                        proteins.push(item.name);
                    }
                    if (item.name.includes('Lettuce') || item.name.includes('Tomatoes') || 
                        item.name.includes('Peppers') || item.name.includes('Zucchini') || 
                        item.name.includes('Eggplant') || item.name.includes('Cucumbers')) {
                        vegetables.push(item.name);
                    }
                });
            });

            // Generate meal suggestions prioritizing dinner, then other meals
            const mealSuggestions = [
                {
                    name: "Pan-Seared Chicken + Cherry Tomato Salad",
                    time: 20,
                    protein: 35,
                    type: "Dinner",
                    servings: 2,
                    priority: 1
                },
                {
                    name: "Black Sea Bass + Grilled Vegetables",
                    time: 25,
                    protein: 28,
                    type: "Dinner", 
                    servings: 2,
                    priority: 1
                },
                {
                    name: "Stuffed Eggplant + Zucchini",
                    time: 35,
                    protein: 12,
                    type: "Lunch",
                    servings: 4,
                    priority: 2
                },
                {
                    name: "Avocado + Egg Breakfast Bowl",
                    time: 10,
                    protein: 18,
                    type: "Breakfast",
                    servings: 1,
                    priority: 3
                },
                {
                    name: "Cucumber + Pepper Fresh Salad",
                    time: 5,
                    protein: 6,
                    type: "Side",
                    servings: 2,
                    priority: 4
                }
            ];

            // Sort by priority (dinner first) and return top 4
            return mealSuggestions.sort((a, b) => a.priority - b.priority).slice(0, 4);
        }

        // Refresh meals button handler
        document.addEventListener('DOMContentLoaded', () => {
            const refreshButton = document.getElementById('refreshMeals');
            if (refreshButton) {
                refreshButton.addEventListener('click', async () => {
                    if (refreshesLeft > 0) {
                        // Disable button during refresh
                        refreshButton.disabled = true;
                        refreshButton.innerHTML = '‚è≥ Generating new meals...';
                        
                        try {
                            // Call API to regenerate meals
                            const response = await fetch('/api/refresh-meals', {
                                method: 'POST',
                                headers: {'Content-Type': 'application/json'},
                                body: JSON.stringify({
                                    cart_data: mealPlanData,
                                    phone: localStorage.getItem('userPhone')
                                })
                            });
                            
                            const data = await response.json();
                            
                            if (data.success) {
                                // Update meal suggestions
                                updateMealSuggestions(data.meals);
                                
                                // Decrement refresh count
                                refreshesLeft--;
                                localStorage.setItem('refreshesLeft', refreshesLeft);
                                
                                // Update button
                                if (refreshesLeft > 0) {
                                    refreshButton.disabled = false;
                                    refreshButton.innerHTML = `üîÑ Try Different Meals (${refreshesLeft} left)`;
                                } else {
                                    refreshButton.disabled = true;
                                    refreshButton.innerHTML = 'üîÑ No refreshes left';
                                    refreshButton.style.background = '#dee2e6';
                                }
                            } else {
                                // Re-enable on error
                                refreshButton.disabled = false;
                                refreshButton.innerHTML = `üîÑ Try Different Meals (${refreshesLeft} left)`;
                                alert('Failed to generate new meals. Please try again.');
                            }
                        } catch (error) {
                            console.error('Error refreshing meals:', error);
                            refreshButton.disabled = false;
                            refreshButton.innerHTML = `üîÑ Try Different Meals (${refreshesLeft} left)`;
                        }
                    }
                });
            }
            
            // Load refresh count from localStorage
            const savedRefreshes = localStorage.getItem('refreshesLeft');
            if (savedRefreshes !== null) {
                refreshesLeft = parseInt(savedRefreshes);
                const refreshSpan = document.getElementById('refreshCount');
                if (refreshSpan) {
                    refreshSpan.textContent = refreshesLeft;
                }
            }
        });

        function updateMealSuggestions(meals) {
            // Update the meal suggestions container with new meals
            const container = document.getElementById('mealSuggestionsContainer');
            if (container && meals) {
                // Clear existing meals
                container.innerHTML = '';
                
                // Add new meals
                meals.forEach(meal => {
                    const mealCard = document.createElement('div');
                    mealCard.className = 'meal-card';
                    mealCard.innerHTML = `
                        <div class="meal-header">
                            <span class="meal-name">${meal.name}</span>
                            <span class="meal-meta">${meal.time} ‚Ä¢ ${meal.protein}g protein</span>
                        </div>
                    `;
                    container.appendChild(mealCard);
                });
            }
        }

        async function refreshCartData() {
            const button = document.getElementById('refreshCartButton');
            const originalText = button.innerHTML;
            
            try {
                button.disabled = true;
                button.innerHTML = '‚è≥ Refreshing...';
                
                // Re-run cart analysis
                await startAnalysis();
                
            } catch (error) {
                console.error('Error refreshing cart:', error);
                alert('Failed to refresh cart data. Please try again.');
            } finally {
                button.disabled = false;
                button.innerHTML = originalText;
            }
        }

        function switchTab(tab, element) {
            // Update active tab
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            element.classList.add('active');

            // Hide all sections
            document.querySelectorAll('.section').forEach(s => s.classList.remove('active'));

            // Show the right section based on state and tab
            if (tab === 'cart') {
                // Cart tab shows the current cart analysis
                if (currentState === 'complete') {
                    document.getElementById('cartAnalysisSection').classList.add('active');
                } else if (currentState === 'loading') {
                    document.getElementById('loadingSection').classList.add('active');
                } else {
                    document.getElementById('startSection').classList.add('active');
                }
            } else if (tab === 'meals') {
                // Meals tab shows meal suggestions
                document.getElementById('mealsSection').classList.add('active');
            } else if (tab === 'settings') {
                // Settings redirects to separate page (handled by href)
                document.getElementById('settingsSection').classList.add('active');
            }
        }

        function showAddToHomeScreen() {
            // iOS Safari
            if (navigator.userAgent.match(/iPhone|iPad|iPod/)) {
                alert('Tap the Share button (‚ÜóÔ∏è) at the bottom of Safari, then tap "Add to Home Screen"');
            } 
            // Android Chrome
            else if (navigator.userAgent.match(/Android/)) {
                alert('Tap the menu (‚ãÆ) in Chrome, then tap "Add to Home screen"');
            } 
            else {
                alert('Use your browser\'s menu to add this page to your home screen');
            }
        }

        // Save credentials when they complete onboarding (called from onboarding.js)
        window.saveUserCredentials = function(email, password) {
            localStorage.setItem('ftpEmail', email);
            localStorage.setItem('ftpPassword', password);
        }
    </script>
</body>
</html>