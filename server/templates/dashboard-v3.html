<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Dashboard - Farm to People</title>

    <!-- PWA Configuration -->
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black">
    <meta name="theme-color" content="#28a745">

    <!-- Professional Fitbod CSS for styling (same as original dashboard) -->
    <link rel="stylesheet" href="/static/css/fitbod_meal_planning.css">

    <style>
        /* Override with light theme colors */
        :root {
            --bg-primary: #f8f9fa !important;
            --bg-secondary: #ffffff !important;
            --bg-card: #ffffff !important;
            --border-subtle: rgba(0, 0, 0, 0.08) !important;
            --text-primary: #1a1a1a !important;
            --text-secondary: #666666 !important;
            --text-tertiary: #999999 !important;
            --accent-blue: #007AFF !important;
            --accent-green: #28a745 !important;
            --accent-red: #dc3545 !important;
            --shadow-card: 0 2px 12px rgba(0, 0, 0, 0.08) !important;
            --shadow-hover: 0 4px 20px rgba(0, 0, 0, 0.12) !important;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background-color: var(--bg-primary);
            color: var(--text-primary);
            padding-bottom: 80px;
        }

        /* Ensure proper header styling */
        .header {
            background: white;
            padding: 20px;
            border-bottom: 1px solid #e9ecef;
            position: sticky;
            top: 0;
            z-index: 100;
        }

        .header h1 {
            font-size: 24px;
            color: #212529;
            margin-bottom: 4px;
        }

        .header .subtitle {
            color: #6c757d;
            font-size: 14px;
        }

        .content {
            padding: 20px;
            max-width: 600px;
            margin: 0 auto;
            min-height: calc(100vh - 200px);
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }
    </style>
</head>
<body>
    <!-- Header -->
    <div class="header">
        <div style="display: flex; justify-content: space-between; align-items: center;">
            <div>
                <h1>Cart Analysis</h1>
                <p class="subtitle" id="headerSubtitle">Ready to analyze your cart</p>
            </div>
            <div id="deliveryDate" style="display: none; text-align: right;">
                <div style="color: #28a745; font-weight: 600; font-size: 16px;" id="deliveryDateText"></div>
                <div style="color: #6c757d; font-size: 12px;">Delivery Date</div>
            </div>
        </div>
    </div>

    <!-- Main Content Container -->
    <div class="content">
        <!-- Cart/Box Tab -->
        <div class="tab-content active" id="boxTab">
            <div id="cartContainer">
                <!-- Cart content will be dynamically loaded -->
            </div>
        </div>

        <!-- Meals/Plan Tab -->
        <div class="tab-content" id="planTab">
            <div id="mealsContainer">
                <!-- Meals content will be dynamically loaded -->
            </div>
        </div>

        <!-- Settings Tab -->
        <div class="tab-content" id="settingsTab">
            <div id="settingsContainer">
                <!-- Settings content will be dynamically loaded -->
            </div>
        </div>
    </div>

    <!-- Bottom Navigation -->
    <div class="bottom-nav">
        <div class="nav-tab active" data-tab="box">
            <svg class="nav-tab-icon" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <circle cx="9" cy="21" r="1"></circle>
                <circle cx="20" cy="21" r="1"></circle>
                <path d="M1 1h4l2.68 13.39a2 2 0 0 0 2 1.61h9.72a2 2 0 0 0 2-1.61L23 6H6"></path>
            </svg>
            <div class="nav-tab-label">Cart</div>
        </div>
        <div class="nav-tab" data-tab="plan">
            <svg class="nav-tab-icon" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <path d="M3 2v7c0 1.1.9 2 2 2h4a2 2 0 0 0 2-2V2"></path>
                <path d="M7 2v20"></path>
                <path d="M21 15V2v0a5 5 0 0 0-5 5v6c0 1.1.9 2 2 2h3Zm0 0v7"></path>
            </svg>
            <div class="nav-tab-label">Meals</div>
        </div>
        <div class="nav-tab" data-tab="settings">
            <svg class="nav-tab-icon" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <circle cx="12" cy="12" r="3"></circle>
                <path d="M12 1v6M12 17v6M4.22 4.22l4.24 4.24M15.54 15.54l4.24 4.24M1 12h6M17 12h6M4.22 19.78l4.24-4.24M15.54 8.46l4.24-4.24"></path>
            </svg>
            <div class="nav-tab-label">Settings</div>
        </div>
    </div>

    <!-- Modals Container -->
    <div id="modalsContainer"></div>

    <!-- JavaScript Modules -->
    <script type="module">
        import { appState } from '/static/js/modules/core.js';
        import { Navigation } from '/static/js/modules/navigation-v2.js';
        import { CartManagerV3 } from '/static/js/modules/cart-v3.js';
        import { MealsManagerV3 } from '/static/js/modules/meals-v3.js';
        import { SettingsManagerV3 } from '/static/js/modules/settings-v3.js';
        import apiClient from '/static/js/modules/api-client.js';

        // Make modules available globally for debugging
        window.appState = appState;
        window.apiClient = apiClient;

        // Initialize modules and make them globally available
        window.navigation = new Navigation();
        window.cartManager = new CartManagerV3();
        window.mealsManager = new MealsManagerV3();
        window.settingsManager = new SettingsManagerV3();

        // Aliases for compatibility
        window.navigationManager = window.navigation;
        window.cartManagerV3 = window.cartManager;
        window.mealsManagerV3 = window.mealsManager;
        window.settingsManagerV3 = window.settingsManager;

        // Initialize app when DOM is ready
        document.addEventListener('DOMContentLoaded', async () => {
            console.log('🚀 Dashboard v3 initializing...');

            // Check for user data
            const userPhone = localStorage.getItem('userPhone');
            const userEmail = localStorage.getItem('ftpEmail');

            if (!userPhone) {
                // Redirect to onboarding if no user data
                window.location.href = '/onboard';
                return;
            }

            // Store user data in app state
            appState.update('user.phone', userPhone);
            appState.update('user.email', userEmail);

            // Initialize navigation (handles tabs without page refresh)
            window.navigation.init();

            // Initialize modules
            await window.cartManager.init();
            await window.mealsManager.init();
            await window.settingsManager.init();

            // Listen for tab changes
            appState.on('tab:changed', (data) => {
                console.log(`📍 Tab changed: ${data.from} → ${data.to}`);
            });

            // Check for existing cart data
            try {
                const savedCart = await apiClient.getSavedCart();
                if (savedCart && savedCart.cart_data) {
                    appState.update('cart.data', savedCart.cart_data);
                    cartManager.displayCartAnalysis(savedCart.cart_data);
                }
            } catch (error) {
                console.log('No saved cart data found');
            }

            console.log('✅ Dashboard v3 initialized');
        });

        // Handle visibility change (for PWA)
        document.addEventListener('visibilitychange', () => {
            if (!document.hidden) {
                // App became visible - check for updates
                const currentTab = appState.get('ui.activeTab');
                appState.emit(`${currentTab}:visible`, {});
            }
        });

        // Handle online/offline
        window.addEventListener('online', () => {
            console.log('📶 Back online');
            appState.emit('network:online', {});
        });

        window.addEventListener('offline', () => {
            console.log('📵 Gone offline');
            appState.emit('network:offline', {});
        });
    </script>
</body>
</html>